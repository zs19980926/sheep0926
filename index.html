<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ—¥æœ¬æ—…éŠè¬ç”¨è¦åŠƒå™¨ (Lite)</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <link rel="manifest" id="my-manifest">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background-color: #0f172a; color: #f1f5f9;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            -webkit-user-select: none; user-select: none;
        }
        input, textarea, select { -webkit-user-select: text; user-select: text; }
        .card-bg { background-color: #1e293b; } 
        .tab-btn.active { border-bottom: 3px solid #38bdf8; color: #38bdf8; font-weight: 600; } 
        /* éš±è—æ²è»¸ */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .modal-enter { transition: opacity 0.2s; opacity: 0; pointer-events: none; }
        .modal-enter-active { opacity: 1; pointer-events: auto; }
        /* Toast é€šçŸ¥ */
        #toast-container { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 100; pointer-events: none; }
        .toast { background: rgba(0,0,0,0.85); color: white; padding: 10px 20px; border-radius: 20px; opacity: 0; transition: opacity 0.3s; margin-top: 5px;}
        .toast.show { opacity: 1; }
    </style>
</head>
<body class="min-h-screen pb-20">

    <div id="toast-container"></div>
    <div id="modal-container"></div>

    <div class="max-w-4xl mx-auto p-4">
        <header class="mb-6 pt-4 flex justify-between items-center">
            <div></div>
            <h1 id="app-title" class="text-2xl font-bold text-white cursor-pointer" onclick="window.editTitle()">ğŸŒ¸ æ—¥æœ¬æ—…éŠ (é»æˆ‘æ”¹å)</h1>
            <button onclick="window.showSettings()" class="text-slate-400 p-2"><i data-lucide="settings" class="w-6 h-6"></i></button>
        </header>

        <div class="flex border-b border-slate-700 mb-6 overflow-x-auto hide-scrollbar gap-4">
            <button class="tab-btn active p-3 whitespace-nowrap" onclick="window.switchTab('itinerary')"><i data-lucide="map-pin" class="inline w-4 h-4"></i> è¡Œç¨‹</button>
            <button class="tab-btn p-3 whitespace-nowrap" onclick="window.switchTab('shopping')"><i data-lucide="shopping-bag" class="inline w-4 h-4"></i> è³¼ç‰©</button>
            <button class="tab-btn p-3 whitespace-nowrap" onclick="window.switchTab('accounting')"><i data-lucide="wallet" class="inline w-4 h-4"></i> è¨˜å¸³</button>
            <button class="tab-btn p-3 whitespace-nowrap" onclick="window.switchTab('packing')"><i data-lucide="briefcase" class="inline w-4 h-4"></i> è¡Œæ</button>
        </div>

        <div id="page-itinerary" class="tab-page">
            <button onclick="window.addItinerary()" class="w-full bg-sky-600 text-white py-3 rounded-xl font-bold mb-4 shadow-lg flex justify-center items-center"><i data-lucide="plus" class="w-5 h-5 mr-2"></i> æ–°å¢è¡Œç¨‹</button>
            <div id="list-itinerary" class="space-y-4"></div>
        </div>

        <div id="page-shopping" class="tab-page hidden">
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="bg-slate-800 p-3 rounded-lg"><p class="text-xs text-slate-400">å¾…è³¼é‡‘é¡</p><p id="shop-total-todo" class="text-xl font-bold text-yellow-400">Â¥0</p></div>
                <div class="bg-slate-800 p-3 rounded-lg"><p class="text-xs text-slate-400">å·²è³¼é‡‘é¡</p><p id="shop-total-done" class="text-xl font-bold text-green-400">Â¥0</p></div>
            </div>
            <button onclick="window.addShopItem()" class="w-full bg-pink-600 text-white py-3 rounded-xl font-bold mb-4 shadow-lg flex justify-center items-center"><i data-lucide="plus" class="w-5 h-5 mr-2"></i> æ–°å¢è³¼ç‰©é …ç›®</button>
            <div id="list-shopping" class="space-y-3"></div>
        </div>

        <div id="page-accounting" class="tab-page hidden">
            <div class="bg-slate-800 p-4 rounded-xl mb-4 border border-slate-700">
                <p class="text-xs text-slate-400">ç¸½æ”¯å‡º (TWD ä¼°ç®—)</p>
                <p id="expense-total" class="text-3xl font-bold text-white mt-1">NT$ 0</p>
                <div class="flex gap-2 mt-3">
                    <input type="number" id="rate-input" value="0.22" class="w-20 bg-slate-900 border border-slate-600 rounded p-1 text-center text-sm text-white" onchange="window.updateRate()">
                    <span class="text-sm text-slate-400 flex items-center">åŒ¯ç‡ (JPY->TWD)</span>
                </div>
            </div>
            <button onclick="window.addExpense()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold mb-4 shadow-lg flex justify-center items-center"><i data-lucide="plus" class="w-5 h-5 mr-2"></i> è¨˜ä¸€ç­†</button>
            <div id="list-expense" class="space-y-3"></div>
        </div>

        <div id="page-packing" class="tab-page hidden">
             <div class="flex gap-2 mb-4">
                <input type="text" id="pack-input" class="flex-1 bg-slate-800 border border-slate-600 rounded-lg p-3 text-white" placeholder="æ–°å¢è¡Œæé …ç›®...">
                <button onclick="window.addPackItem()" class="bg-indigo-600 text-white px-4 rounded-lg font-bold">æ–°å¢</button>
            </div>
            <div id="list-packing" class="space-y-2"></div>
        </div>
    </div>

    <script>
        // --- 1. è³‡æ–™åº« (ä½¿ç”¨ LocalStorage, ä¸æœƒç•¶æ©Ÿ) ---
        const DB_KEY = 'japan_trip_lite_v1';
        let data = JSON.parse(localStorage.getItem(DB_KEY)) || {
            title: 'ğŸŒ¸ æ—¥æœ¬æ—…éŠ',
            rate: 0.22,
            itineraries: [],
            shopping: [],
            expenses: [],
            packing: []
        };

        function save() {
            localStorage.setItem(DB_KEY, JSON.stringify(data));
            renderAll();
        }

        // --- 2. æ ¸å¿ƒåŠŸèƒ½ ---
        window.switchTab = (tabName) => {
            document.querySelectorAll('.tab-page').forEach(el => el.classList.add('hidden'));
            document.getElementById('page-' + tabName).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
        };

        window.editTitle = () => {
            const newTitle = prompt("è«‹è¼¸å…¥æ–°çš„æ—…éŠæ¨™é¡Œ:", data.title);
            if(newTitle) { data.title = newTitle; save(); }
        }

        window.showSettings = () => {
            if(confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è³‡æ–™å—ï¼Ÿ(æœƒæ¸…ç©ºæ‰€æœ‰ç´€éŒ„)")) {
                localStorage.removeItem(DB_KEY);
                location.reload();
            }
        }

        window.updateRate = () => {
            data.rate = parseFloat(document.getElementById('rate-input').value) || 0.22;
            save();
        }

        // --- 3. è¡Œç¨‹åŠŸèƒ½ ---
        window.addItinerary = () => {
            const title = prompt("è¡Œç¨‹åç¨± (ä¾‹å¦‚: æ¸…æ°´å¯º):");
            if(!title) return;
            const time = prompt("æ™‚é–“ (ä¾‹å¦‚: 14:00):", "09:00");
            data.itineraries.push({ id: Date.now(), title, time, note: '' });
            save();
        }
        
        window.delItinerary = (id) => {
            if(confirm("åˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ")) {
                data.itineraries = data.itineraries.filter(i => i.id !== id);
                save();
            }
        }

        function renderItineraries() {
            const list = document.getElementById('list-itinerary');
            list.innerHTML = data.itineraries.sort((a,b) => a.time.localeCompare(b.time)).map(i => `
                <div class="card-bg p-4 rounded-xl border border-slate-700 flex justify-between items-center shadow-md">
                    <div>
                        <span class="text-sky-400 font-bold text-lg mr-2">${i.time}</span>
                        <span class="text-white font-bold text-lg">${i.title}</span>
                    </div>
                    <button onclick="window.delItinerary(${i.id})" class="text-red-400 p-2"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                </div>
            `).join('') || '<div class="text-center text-slate-500 py-8">é‚„æ²’æœ‰è¡Œç¨‹ï¼ŒæŒ‰ä¸Šé¢æŒ‰éˆ•æ–°å¢ï¼</div>';
        }

        // --- 4. è³¼ç‰©åŠŸèƒ½ ---
        window.addShopItem = () => {
            const name = prompt("å•†å“åç¨±:");
            if(!name) return;
            const price = prompt("åƒ¹æ ¼ (JPY):", "0");
            data.shopping.push({ id: Date.now(), name, price: parseInt(price)||0, isBought: false });
            save();
        }

        window.toggleShop = (id) => {
            const item = data.shopping.find(i => i.id === id);
            if(item) { item.isBought = !item.isBought; save(); }
        }

        window.delShop = (id) => {
            if(confirm("åˆªé™¤æ­¤å•†å“ï¼Ÿ")) {
                data.shopping = data.shopping.filter(i => i.id !== id);
                save();
            }
        }

        function renderShopping() {
            let todo = 0, done = 0;
            const html = data.shopping.map(i => {
                if(i.isBought) done += i.price; else todo += i.price;
                return `
                <div class="card-bg p-3 rounded-xl border border-slate-700 flex items-center gap-3 ${i.isBought ? 'opacity-50' : ''}">
                    <button onclick="window.toggleShop(${i.id})" class="w-6 h-6 rounded border flex items-center justify-center ${i.isBought ? 'bg-green-500 border-green-500' : 'border-slate-500'}">
                        ${i.isBought ? '<i data-lucide="check" class="w-4 h-4 text-white"></i>' : ''}
                    </button>
                    <div class="flex-1">
                        <div class="text-white font-bold ${i.isBought ? 'line-through text-slate-400' : ''}">${i.name}</div>
                        <div class="text-xs text-slate-400">Â¥${i.price}</div>
                    </div>
                    <button onclick="window.delShop(${i.id})" class="text-slate-500"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>`;
            }).join('');
            
            document.getElementById('list-shopping').innerHTML = html || '<div class="text-center text-slate-500 py-8">æ¸…å–®ç©ºç©ºå¦‚ä¹Ÿ</div>';
            document.getElementById('shop-total-todo').innerText = 'Â¥' + todo;
            document.getElementById('shop-total-done').innerText = 'Â¥' + done;
        }

        // --- 5. è¨˜å¸³åŠŸèƒ½ ---
        window.addExpense = () => {
            const desc = prompt("æ¶ˆè²»é …ç›® (å¦‚: æ‹‰éºµ):");
            if(!desc) return;
            const amt = prompt("é‡‘é¡ (JPY):");
            if(!amt) return;
            data.expenses.push({ id: Date.now(), desc, amt: parseInt(amt)||0 });
            save();
        }

        window.delExpense = (id) => {
            if(confirm("åˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ")) {
                data.expenses = data.expenses.filter(i => i.id !== id);
                save();
            }
        }

        function renderExpenses() {
            let totalTWD = 0;
            const html = data.expenses.map(i => {
                const twd = Math.round(i.amt * data.rate);
                totalTWD += twd;
                return `
                <div class="card-bg p-3 rounded-xl border-l-4 border-green-500 shadow-sm flex justify-between items-center">
                    <div>
                        <div class="text-white font-bold">${i.desc}</div>
                        <div class="text-xs text-slate-400">Â¥${i.amt} (ç´„ NT$${twd})</div>
                    </div>
                    <button onclick="window.delExpense(${i.id})" class="text-slate-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>`;
            }).join('');
            
            document.getElementById('list-expense').innerHTML = html || '<div class="text-center text-slate-500 py-8">é‚„æ²’æœ‰è¨˜å¸³</div>';
            document.getElementById('expense-total').innerText = 'NT$ ' + totalTWD;
        }

        // --- 6. è¡ŒæåŠŸèƒ½ ---
        window.addPackItem = () => {
            const input = document.getElementById('pack-input');
            if(!input.value) return;
            data.packing.push({ id: Date.now(), text: input.value, checked: false });
            input.value = '';
            save();
        }

        window.togglePack = (id) => {
            const item = data.packing.find(i => i.id === id);
            if(item) { item.checked = !item.checked; save(); }
        }

        window.delPack = (id) => {
            data.packing = data.packing.filter(i => i.id !== id);
            save();
        }

        function renderPacking() {
            document.getElementById('list-packing').innerHTML = data.packing.map(i => `
                <div class="bg-slate-800 p-3 rounded-lg flex items-center justify-between border border-slate-700">
                    <div class="flex items-center gap-3 flex-1 cursor-pointer" onclick="window.togglePack(${i.id})">
                        <div class="w-5 h-5 rounded border ${i.checked ? 'bg-indigo-500 border-indigo-500' : 'border-slate-500'} flex items-center justify-center">
                            ${i.checked ? '<i data-lucide="check" class="w-3 h-3 text-white"></i>' : ''}
                        </div>
                        <span class="${i.checked ? 'line-through text-slate-500' : 'text-white'}">${i.text}</span>
                    </div>
                    <button onclick="window.delPack(${i.id})" class="text-slate-500"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
            `).join('');
        }

        // --- å•Ÿå‹•èˆ‡æ¸²æŸ“ ---
        function renderAll() {
            document.getElementById('app-title').innerText = data.title + " (é»æˆ‘æ”¹å)";
            document.getElementById('rate-input').value = data.rate;
            renderItineraries();
            renderShopping();
            renderExpenses();
            renderPacking();
            if(window.lucide) lucide.createIcons();
            
            // å‹•æ…‹ç”¢ç”Ÿ Manifest åœ–ç¤º
            const svg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' style='background-color:#0f172a'><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='300' dy='.1em'>ğŸŒ¸</text></svg>`;
            const blob = new Blob([JSON.stringify({
                name: "æ—¥æœ¬éŠ", short_name: "æ—¥æœ¬éŠ", start_url: ".", display: "standalone",
                background_color: "#0f172a", theme_color: "#0f172a",
                icons: [{ src: "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(svg))), sizes: "512x512", type: "image/svg+xml" }]
            })], {type: 'application/json'});
            document.getElementById('my-manifest').href = URL.createObjectURL(blob);
        }

        // å•Ÿå‹•ï¼
        window.addEventListener('load', () => {
            renderAll();
            // è¨»å†Š PWA
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js');
        });
    </script>
</body>
</html>
