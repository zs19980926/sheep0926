<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA è¨­å®š (iOS) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ—¥æœ¬éŠ">
    
    <!-- PWA Manifest è¨­å®š (Android/Desktop) - ä½¿ç”¨ Data URI åµŒå…¥ -->
    <link rel="manifest" id="my-manifest">
    
    <!-- è¨­å®šä¸»é¡Œé¡è‰² (æ­é… manifest çš„ theme_color) -->
    <meta name="theme-color" content="#0f172a">

    <title>æ—¥æœ¬æ—…éŠè¬ç”¨è¦åŠƒå™¨</title>

    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    
    <script>
        // å‹•æ…‹ç”Ÿæˆ Manifest (åŒ…å«æ‚¨çš„è¨­å®šèˆ‡åœ–ç¤º)
        document.addEventListener('DOMContentLoaded', () => {
            // æ«»èŠ±åœ–ç¤º SVG (Base64)
            const iconSvg = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="background-color:#0f172a">
                <circle cx="256" cy="256" r="256" fill="#1e293b"/>
                <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="300" dy=".1em">ğŸŒ¸</text>
            </svg>`;
            const iconUrl = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(iconSvg)));

            const manifest = {
                "name": "æˆ‘çš„æ—¥æœ¬æ—…éŠ App",
                "short_name": "æ—¥æœ¬éŠ",
                "start_url": ".", 
                "display": "standalone",
                "background_color": "#0f172a", 
                "theme_color": "#0f172a",
                "orientation": "portrait",
                "icons": [
                    {
                        "src": iconUrl,
                        "sizes": "192x192",
                        "type": "image/svg+xml"
                    },
                    {
                        "src": iconUrl,
                        "sizes": "512x512",
                        "type": "image/svg+xml"
                    }
                ]
            };

            const stringManifest = JSON.stringify(manifest);
            const blob = new Blob([stringManifest], {type: 'application/json'});
            const manifestURL = URL.createObjectURL(blob);
            document.querySelector('#my-manifest').setAttribute('href', manifestURL);
        });
    </script>
    
    <style>
        /* æ·±è—è‰²ä¸»é¡Œèˆ‡æ«»èŠ±èƒŒæ™¯ */
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
            background-color: #0f172a; /* Slate 900 */
            color: #f1f5f9; /* Slate 100 */
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='10' cy='10' r='2' fill='rgba(255, 255, 255, 0.05)' /%3E%3Ccircle cx='55' cy='30' r='2' fill='rgba(255, 255, 255, 0.05)' /%3E%3Ccircle cx='30' cy='70' r='2' fill='rgba(255, 255, 255, 0.05)' /%3E%3C/svg%3E");
            background-size: 50px 50px;
            /* é‡å° iPhone X+ çš„ç€æµ·èˆ‡åº•éƒ¨æ©«æ¢é¿è®“ */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            -webkit-user-select: none;
            user-select: none;
            overscroll-behavior-y: none; 
        }
        
        input, textarea, select { -webkit-user-select: text; user-select: text; }

        .card-bg { background-color: #1e293b !important; } 
        .text-primary { color: #f1f5f9 !important; } 
        .text-secondary { color: #94a3b8 !important; }
        .text-accent { color: #38bdf8 !important; } 

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .tab-btn { color: #94a3b8; }
        .tab-btn.active { border-bottom: 3px solid #38bdf8; color: #38bdf8; font-weight: 600; } 

        .itinerary-item { cursor: grab; }
        
        /* Modal å‹•ç•« */
        .modal-enter { transition: opacity 0.2s ease; opacity: 0; pointer-events: none; }
        .modal-enter-active { opacity: 1; pointer-events: auto; }
        .animate-bounce-in { animation: bounce-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes bounce-in {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        /* Toast é€šçŸ¥ */
        #toast-container {
            position: fixed;
            bottom: 90px; 
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }
        .toast {
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            text-align: center;
            backdrop-filter: blur(4px);
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        
        a.nav-link { color: #38bdf8; text-decoration: underline; font-weight: 500;}
        a.nav-link:hover { color: #7dd3fc; }
        
        /* è³¼ç‰©æ¸…å–®æ¨£å¼ */
        .shop-item.bought { opacity: 0.6; }
        .shop-item.bought h4 { text-decoration: line-through; color: #94a3b8; }
        .shop-img { object-fit: cover; border-radius: 6px; }

        /* è¡Œææ¸…å–®æ¨£å¼ */
        .packing-item input:checked + span { text-decoration: line-through; color: #64748b; }
        
        /* AI Button Animation */
        .ai-btn-glow {
            animation: pulse-purple 2s infinite;
        }
        @keyframes pulse-purple {
            0% { box-shadow: 0 0 0 0 rgba(168, 85, 247, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(168, 85, 247, 0); }
            100% { box-shadow: 0 0 0 0 rgba(168, 85, 247, 0); }
        }

        /* 4. ç¾åŒ–ä¸‹æ‹‰é¸å–® (iOS/Android é©æ‡‰) */
        select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem !important;
            background-color: #1e293b; /* slate-800 */
            color: white;
            border: 1px solid #475569; /* slate-600 */
        }
        select:focus {
            outline: none;
            border-color: #38bdf8; /* sky-400 */
            ring: 2px solid #38bdf8;
        }
        /* é‡å°å¤©æ°£é¸å–®çš„ç‰¹æ®Šæ¨£å¼ (é€æ˜èƒŒæ™¯) */
        #weather-city {
            background-color: transparent;
            border: none;
            padding-right: 1.5rem !important;
            color: white;
        }
    </style>
</head>
<body class="min-h-screen pb-24 md:pb-8">

    <!-- Toast å®¹å™¨ -->
    <div id="toast-container"></div>

    <!-- ä¸»æ‡‰ç”¨ç¨‹å¼å®¹å™¨ -->
    <div id="app" class="max-w-4xl mx-auto p-4 md:p-8">
        <header class="mb-6 pt-4 flex justify-between items-start px-2 relative">
            <div class="flex-1"></div>
            <div class="text-center flex flex-col items-center">
                <!-- 1. å¯æ›´æ”¹æ¨™é¡Œ -->
                <div class="flex items-center gap-2 justify-center cursor-pointer group" onclick="window.showSettingsModal()">
                    <h1 id="trip-title-display" class="text-2xl md:text-3xl font-extrabold text-primary tracking-tight truncate max-w-[200px] md:max-w-md">ğŸŒ¸ æ—¥æœ¬æ—…éŠè¦åŠƒå™¨</h1>
                    <i data-lucide="edit-2" class="w-4 h-4 text-slate-500 group-hover:text-white transition"></i>
                </div>
                <p class="text-[10px] text-secondary mt-1">App ID: <span id="app-id-display">...</span></p>
            </div>
            
            <!-- è¨­å®šèˆ‡é¸å–®æŒ‰éˆ• -->
            <div class="flex-1 text-right flex flex-col items-end gap-2">
                <button onclick="window.showSettingsModal()" class="text-slate-400 hover:text-white p-2">
                    <i data-lucide="settings" class="w-6 h-6"></i>
                </button>
                <span id="current-user-badge" class="hidden text-xs bg-slate-700 text-sky-300 px-2 py-1 rounded-full border border-slate-600">
                    <i data-lucide="user" class="w-3 h-3 inline mr-1"></i><span id="current-user-name"></span>
                </span>
            </div>
        </header>

        <!-- æ¨¡æ…‹è¦–çª—å®¹å™¨ -->
        <div id="modal-container"></div>

        <!-- ä¸»è¦åŠŸèƒ½åˆ‡æ›ä»‹é¢ -->
        <div class="card-bg rounded-xl shadow-2xl p-4 md:p-6 min-h-[60vh]">
            <!-- å°èˆªåˆ— -->
            <div id="tabs" class="flex justify-between border-b border-slate-700 mb-6 overflow-x-auto hide-scrollbar">
                <button class="tab-btn active p-3 text-center transition duration-150 ease-in-out flex-shrink-0 whitespace-nowrap" data-tab="itinerary">
                    <i data-lucide="map-pin" class="w-5 h-5 inline-block mr-1"></i> è¡Œç¨‹
                </button>
                <button class="tab-btn p-3 text-center transition duration-150 ease-in-out flex-shrink-0 whitespace-nowrap" data-tab="shopping">
                    <i data-lucide="shopping-bag" class="w-5 h-5 inline-block mr-1"></i> è³¼ç‰©
                </button>
                <button class="tab-btn p-3 text-center transition duration-150 ease-in-out flex-shrink-0 whitespace-nowrap" data-tab="accounting">
                    <i data-lucide="wallet" class="w-5 h-5 inline-block mr-1"></i> è¨˜å¸³
                </button>
                <button class="tab-btn p-3 text-center transition duration-150 ease-in-out flex-shrink-0 whitespace-nowrap" data-tab="travel-info">
                    <i data-lucide="info" class="w-5 h-5 inline-block mr-1"></i> è³‡è¨Š
                </button>
                <button class="tab-btn p-3 text-center transition duration-150 ease-in-out flex-shrink-0 whitespace-nowrap" data-tab="packing-tips">
                    <i data-lucide="briefcase" class="w-5 h-5 inline-block mr-1"></i> å¿…å‚™
                </button>
                <button class="tab-btn p-3 text-center transition duration-150 ease-in-out flex-shrink-0 whitespace-nowrap" data-tab="currency">
                    <i data-lucide="hand-coins" class="w-5 h-5 inline-block mr-1"></i> åŒ¯ç‡
                </button>
            </div>

            <!-- å…§å®¹å€å¡Š -->
            <div id="tab-content" class="pb-4">
                
                <!-- 1. è¡Œç¨‹è¦åŠƒ (å«å¤©æ°£) -->
                <div id="itinerary" class="tab-page">
                    <!-- å¤©æ°£å€å¡Š -->
                    <div class="mb-6 bg-slate-800 p-4 rounded-xl border border-slate-600 shadow-lg">
                        <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2">
                            <div class="flex items-center gap-2">
                                <i data-lucide="map-pin" class="w-4 h-4 text-sky-400"></i>
                                <select id="weather-city" onchange="window.saveWeatherCity()" class="font-bold text-lg focus:outline-none cursor-pointer">
                                    <option value="tokyo">æ±äº¬ (Tokyo)</option>
                                    <option value="osaka">å¤§é˜ª (Osaka)</option>
                                    <option value="kyoto">äº¬éƒ½ (Kyoto)</option>
                                    <option value="fukuoka">ç¦å²¡ (Fukuoka)</option>
                                    <option value="sapporo">æœ­å¹Œ (Sapporo)</option>
                                    <option value="okinawa">æ²–ç¹© (Okinawa)</option>
                                </select>
                            </div>
                            <button onclick="window.fetchWeather()" class="text-sky-400 hover:text-white p-1 rounded-full hover:bg-slate-700 transition"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
                        </div>
                        
                        <div id="weather-container">
                             <div class="text-center text-slate-400 text-sm py-4">è¼‰å…¥æ°£è±¡è³‡è¨Šä¸­...</div>
                        </div>
                    </div>

                    <h2 class="text-xl font-bold text-primary mb-4 flex justify-between items-center">
                        æ—…éŠè¡Œç¨‹
                        <div class="flex gap-2">
                             <button onclick="window.showAiPlanModal()" class="ai-btn-glow bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-3 rounded-lg shadow-md transition duration-150 text-sm flex items-center">
                                <i data-lucide="sparkles" class="w-4 h-4 mr-1"></i> AI æ¨è–¦
                            </button>
                            <button onclick="window.showAddItineraryModal()" class="bg-sky-500 hover:bg-sky-600 text-white font-medium py-2 px-4 rounded-lg shadow-md transition duration-150 text-sm flex items-center">
                                <i data-lucide="plus" class="w-4 h-4 mr-1"></i> æ–°å¢
                            </button>
                        </div>
                    </h2>
                    
                    <div id="itinerary-status" class="flex justify-center items-center h-40">
                        <p class="text-secondary" id="itinerary-loading">è¼‰å…¥ä¸­...</p>
                        <p class="text-secondary hidden" id="itinerary-empty">å°šæœªæœ‰ä»»ä½•è¡Œç¨‹ï¼Œé»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢ï¼</p>
                    </div>

                    <div id="itinerary-days-container" class="space-y-8"></div>
                </div>

                <!-- 2. è³¼ç‰©æ¸…å–® -->
                <div id="shopping" class="tab-page hidden">
                     <h2 class="text-xl font-bold text-primary mb-4 flex justify-between items-center">
                        è³¼ç‰©/ä»£è³¼æ¸…å–®
                        <div class="flex gap-2">
                            <button onclick="window.showShoppingSettlement()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg shadow-md transition duration-150 text-sm flex items-center">
                                <i data-lucide="calculator" class="w-4 h-4 mr-1"></i> ä»£è³¼çµç®—
                            </button>
                            <button onclick="window.showAddShoppingItemModal()" class="bg-pink-600 hover:bg-pink-700 text-white font-medium py-2 px-4 rounded-lg shadow-md transition duration-150 text-sm flex items-center">
                                <i data-lucide="plus" class="w-4 h-4 mr-1"></i> æ–°å¢
                            </button>
                        </div>
                    </h2>

                    <!-- ä»£è³¼åå–®ç®¡ç† -->
                    <div class="mb-6 p-4 border border-pink-800 rounded-xl bg-slate-800 shadow-md">
                        <h3 class="text-sm font-semibold text-pink-300 mb-2 flex items-center">
                            <i data-lucide="users" class="w-4 h-4 inline mr-2"></i> ä»£è³¼åå–®ç®¡ç† (åƒ…ç¶½è™Ÿ)
                        </h3>
                        <div class="flex gap-2 mb-2">
                            <input type="text" id="new-proxy-name" placeholder="è¼¸å…¥åå­— (ä¾‹å¦‚: éš”å£è€ç‹)" class="flex-grow p-2 border border-slate-600 rounded-lg bg-slate-700 text-primary text-sm">
                            <button onclick="window.addProxyTarget()" class="bg-pink-600 hover:bg-pink-700 text-white px-3 rounded-lg text-sm shrink-0">æ–°å¢</button>
                        </div>
                        <div id="proxy-list-container" class="flex flex-wrap gap-2 text-sm text-secondary"></div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <div class="bg-slate-700 p-3 rounded-lg border border-slate-600">
                            <p class="text-xs text-secondary">å¾…è³¼é ä¼° (JPY)</p>
                            <p id="shop-todo-total" class="text-xl font-bold text-yellow-400 mt-1">0</p>
                        </div>
                        <div class="bg-slate-700 p-3 rounded-lg border border-slate-600">
                            <p class="text-xs text-secondary">å·²è³¼ç¸½é¡ (JPY)</p>
                            <p id="shop-done-total" class="text-xl font-bold text-green-400 mt-1">0</p>
                        </div>
                    </div>

                    <div id="shopping-status" class="flex justify-center items-center h-40">
                        <p class="text-secondary hidden" id="shopping-loading">è¼‰å…¥ä¸­...</p>
                        <p class="text-secondary" id="shopping-empty">æ¸…å–®ç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«å»è²·è²·è²·ï¼</p>
                    </div>

                    <div id="shopping-list-container" class="space-y-3"></div>
                </div>

                <!-- 3. è¨˜å¸³/åˆ†å¸³ -->
                <div id="accounting" class="tab-page hidden">
                    <h2 class="text-xl font-bold text-primary mb-4 flex justify-between items-center">
                        åˆ†å¸³è¨˜å¸³
                        <div class="flex gap-2">
                            <button onclick="window.triggerGeminiReceipt()" class="ai-btn-glow bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg shadow-md transition duration-150 text-sm flex items-center">
                                <i data-lucide="sparkles" class="w-4 h-4 mr-1"></i> AI æƒæ”¶æ“š
                            </button>
                            <button onclick="window.showAddExpenseModal()" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg shadow-md transition duration-150 text-sm flex items-center">
                                <i data-lucide="plus" class="w-4 h-4 mr-1"></i> è¨˜ä¸€ç­†
                            </button>
                        </div>
                    </h2>
                    
                    <input type="file" id="receipt-upload" accept="image/*" class="hidden" onchange="window.handleReceiptUpload(this)">

                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <div class="bg-slate-700 p-3 rounded-lg">
                            <p class="text-xs text-secondary">ç¸½æ”¯å‡º (ç´„ TWD)</p>
                            <p id="total-twd" class="text-xl font-bold text-primary mt-1">0</p>
                        </div>
                        <div class="bg-slate-700 p-3 rounded-lg">
                            <p class="text-xs text-secondary">çµç®—å»ºè­°</p>
                            <p id="total-settlement" class="text-xl font-bold text-red-400 mt-1">0</p>
                        </div>
                    </div>
                    
                    <div id="settlement-section" class="mb-6 p-4 border border-red-800 rounded-xl bg-red-900/10 hidden">
                        <h3 class="text-sm font-semibold text-red-400 mb-3 flex items-center">
                            <i data-lucide="send" class="w-4 h-4 mr-2"></i> å»ºè­°çµç®—æ–¹å¼
                        </h3>
                        <div id="settlement-transactions" class="space-y-2 text-primary text-sm"></div>
                    </div>

                    <div id="expense-status">
                        <p class="text-secondary text-center py-8" id="expense-loading">è¼‰å…¥ä¸­...</p>
                        <p class="text-secondary text-center py-8 hidden" id="expense-empty">ç„¡æ”¯å‡ºç´€éŒ„ã€‚</p>
                    </div>
                    <ul id="expense-list" class="space-y-3 pb-20"></ul>
                </div>

                <!-- 4. æ—…éŠè³‡è¨Š -->
                <div id="travel-info" class="tab-page hidden">
                    <h2 class="text-xl font-bold text-primary mb-4">æ—…éŠè³‡è¨Šèˆ‡è¨­å®š</h2>

                    <div class="mb-6 p-4 border border-yellow-700/50 rounded-xl bg-yellow-900/10 shadow-md">
                        <h3 class="text-lg font-semibold text-yellow-400 mb-2 flex items-center">
                            <i data-lucide="smartphone" class="w-5 h-5 mr-2"></i> æœ¬æ©Ÿä½¿ç”¨è€…è¨­å®š
                        </h3>
                        <p class="text-xs text-secondary mb-3">è¨­å®šå¾Œï¼Œæ‚¨çš„å¡ç‰‡å°‡ç½®é ‚ï¼Œä¸”è¨˜å¸³èˆ‡è³¼ç‰©æ™‚è‡ªå‹•å¸¶å…¥èº«åˆ†ã€‚</p>
                        <div class="flex gap-2">
                            <select id="current-user-select" class="flex-grow p-2 rounded-lg text-sm">
                                <option value="">-- è«‹é¸æ“‡æˆ‘æ˜¯èª° --</option>
                            </select>
                            <button onclick="window.saveCurrentUser()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg text-sm shrink-0">å„²å­˜</button>
                        </div>
                    </div>

                    <!-- æ—…ä¼´ç®¡ç† -->
                    <div class="mb-6 p-4 border border-blue-800 rounded-xl bg-slate-800 shadow-md">
                        <h3 class="text-lg font-semibold text-accent mb-3 flex items-center">
                            <i data-lucide="users" class="w-5 h-5 mr-2"></i> æ—…ä¼´ç®¡ç† (å«è­·ç…§/Email)
                        </h3>
                        <div class="flex gap-2 mb-3">
                             <input type="text" id="new-participant-name" placeholder="è¼¸å…¥åå­— (å¦‚: å°æ˜)" class="flex-grow p-2 border border-slate-600 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-slate-700 text-primary text-sm">
                            <button onclick="window.addParticipant()" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded-lg text-sm transition shrink-0">æ–°å¢</button>
                        </div>
                        <div id="participants-list" class="flex flex-wrap gap-2 mb-3 min-h-[30px]"></div>
                        
                        <!-- Detailed Info List -->
                        <div class="mt-4 border-t border-slate-700 pt-4">
                            <div id="detailed-participants-list" class="grid grid-cols-1 gap-4">
                                <!-- Items here -->
                            </div>
                            <p class="text-secondary text-sm col-span-full mt-2 hidden" id="detailed-participants-empty">ç„¡æ—…ä¼´è³‡æ–™ã€‚</p>
                        </div>
                    </div>

                    <!-- é£¯åº—è³‡è¨Š -->
                    <div class="mb-6 p-4 border border-purple-800 rounded-xl bg-slate-800 shadow-md">
                        <h3 class="text-lg font-semibold text-purple-300 mb-3 flex items-center justify-between">
                            <span><i data-lucide="bed-double" class="w-5 h-5 inline mr-2"></i> é£¯åº—è³‡è¨Š</span>
                            <button onclick="window.showEditHotelModal()" class="text-sm bg-purple-700 hover:bg-purple-600 text-white px-3 py-1 rounded">ç·¨è¼¯</button>
                        </h3>
                        <div id="hotel-info-display" class="space-y-2 text-secondary text-sm">
                            <p>è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>

                    <div class="p-4 border border-blue-800 rounded-xl bg-slate-800 shadow-md">
                        <h3 class="text-lg font-semibold text-accent mb-3 flex items-center justify-between">
                            <span><i data-lucide="plane" class="w-5 h-5 inline mr-2"></i> èˆªç­è³‡è¨Š</span>
                            <button onclick="window.showEditFlightModal()" class="text-sm bg-blue-600 px-3 py-1 rounded text-white">ç·¨è¼¯</button>
                        </h3>
                        <div id="flight-info-display" class="space-y-2 text-secondary text-sm">
                            <p>è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>
                </div>

                <!-- 5. å¿…å‚™æ¸…å–® & æ³¨æ„äº‹é … -->
                <div id="packing-tips" class="tab-page hidden">
                    <h2 class="text-xl font-bold text-primary mb-4 flex justify-between items-center">
                        æ³¨æ„äº‹é … & è¡Œææ¸…å–®
                        <button onclick="window.generateAIPackingList()" class="ai-btn-glow bg-purple-600 hover:bg-purple-700 text-white font-medium py-1.5 px-3 rounded-lg shadow-md transition duration-150 text-sm flex items-center">
                            <i data-lucide="sparkles" class="w-4 h-4 mr-1"></i> AI æ¨è–¦æ¸…å–®
                        </button>
                    </h2>
                    
                    <!-- æ³¨æ„äº‹é …å¡ç‰‡ -->
                    <div class="bg-amber-900/20 border border-amber-700/50 p-4 rounded-xl mb-6">
                        <h3 class="text-lg font-bold text-amber-400 mb-2"><i data-lucide="alert-triangle" class="w-5 h-5 inline mr-1"></i> æ—…æ—¥é‡è¦é ˆçŸ¥</h3>
                        <ul class="list-disc list-inside text-sm text-slate-300 space-y-1">
                            <li>å…¥å¢ƒå¡ï¼šè«‹è‡³ Visit Japan Web å¡«å¯«å…¥å¢ƒå¯©æŸ¥èˆ‡æµ·é—œç”³å ±ã€‚</li>
                            <li>é›»å£“ï¼šæ—¥æœ¬é›»å£“ 100Vï¼Œæ’åº§ç‚ºé›™å¹³è…³ (Aå‹)ï¼Œå°ç£é›»å™¨é€šå¸¸é€šç”¨ã€‚</li>
                            <li>è¡Œå‹•é›»æºï¼š<span class="text-red-400 font-bold">å¿…é ˆæ‰‹æä¸Šæ©Ÿ</span>ï¼Œä¸å¯è¨—é‹ã€‚</li>
                            <li>ç¶²è·¯ï¼šå»ºè­°äº‹å…ˆè³¼è²· eSIM æˆ–æ¼«éŠï¼Œæˆ–ç§Ÿç”¨ WiFi æ©Ÿã€‚</li>
                            <li>é€€ç¨…ï¼šæœªç¨…æ»¿ 5000 æ—¥åœ“å¯é€€ç¨…ï¼Œéœ€å‡ºç¤ºè­·ç…§ (Visit Japan Web QR Code ä¹Ÿå¯)ã€‚</li>
                        </ul>
                    </div>

                    <!-- è¡Œææ¸…å–®åˆ‡æ› -->
                    <div class="flex border-b border-slate-700 mb-4">
                        <button class="flex-1 py-2 text-center text-sm font-medium text-sky-400 border-b-2 border-sky-400" id="btn-pack-out" onclick="window.switchPackTab('outbound')">ğŸ‡¯ğŸ‡µ å»ç¨‹ (å‡ºåœ‹å‰)</button>
                        <button class="flex-1 py-2 text-center text-sm font-medium text-slate-500 border-b-2 border-transparent" id="btn-pack-in" onclick="window.switchPackTab('inbound')">ğŸ  å›ç¨‹ (å›åœ‹å‰)</button>
                    </div>

                    <!-- è¼¸å…¥æ¡† -->
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="new-pack-item" placeholder="æ–°å¢æ¸…å–®é …ç›®..." class="flex-1 bg-slate-800 border-slate-600 rounded-lg p-2 text-white text-sm">
                        <button onclick="window.addPackingItem()" class="bg-green-600 hover:bg-green-700 text-white px-4 rounded-lg"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>

                    <!-- æ¸…å–®å®¹å™¨ -->
                    <div id="packing-list-container" class="space-y-2 pb-20">
                        <!-- Items rendered here -->
                    </div>
                </div>

                <!-- 7. åŒ¯ç‡ -->
                <div id="currency" class="tab-page hidden">
                    <h2 class="text-xl font-bold text-primary mb-4">åŒ¯ç‡ç®—ç›¤</h2>
                    
                    <div class="bg-slate-700 p-3 rounded-lg mb-4 text-center">
                        <p class="text-sm text-secondary">å°æ–°/åœ‹æ³° VISA å¹³å‡åŒ¯ç‡</p>
                        <p class="text-2xl font-bold text-yellow-400 mt-1">1 JPY â‰ˆ <span id="rate-display">0.2200</span> TWD</p>
                    </div>

                    <div class="space-y-4 bg-slate-800 p-6 rounded-xl border border-slate-700">
                        <div>
                            <label class="text-xs text-secondary">æ–°å°å¹£ (TWD)</label>
                            <input type="number" id="twd-input" inputmode="decimal" oninput="window.convertCurrency('TWD')" class="w-full p-3 text-lg border border-slate-600 rounded-lg bg-slate-900 text-primary mt-1">
                        </div>
                        <div class="text-center text-secondary"><i data-lucide="arrow-down-up" class="w-6 h-6 inline"></i></div>
                        <div>
                            <label class="text-xs text-secondary">æ—¥åœ“ (JPY)</label>
                            <input type="number" id="jpy-input" inputmode="decimal" oninput="window.convertCurrency('JPY')" class="w-full p-3 text-lg border border-slate-600 rounded-lg bg-slate-900 text-primary mt-1">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================================================================
        //  GitHub / Vercel éƒ¨ç½²è¨­å®šå€
        //  è«‹å¡«å¯«æ‚¨çš„ Firebase è¨­å®šç‰©ä»¶ (å¾ Firebase Console -> Project Settings -> General -> Your apps è¤‡è£½)
        // =================================================================================
        const MANUAL_FIREBASE_CONFIG = {
             // apiKey: "è«‹å¡«å…¥æ‚¨çš„ API Key",
             // authDomain: "æ‚¨çš„å°ˆæ¡ˆID.firebaseapp.com",
             // projectId: "æ‚¨çš„å°ˆæ¡ˆID",
             // storageBucket: "æ‚¨çš„å°ˆæ¡ˆID.appspot.com",
             // messagingSenderId: "...",
             // appId: "..."
        };

        const MANUAL_APP_ID = "my-japan-trip-v1"; // å¯è‡ªè¨‚æ‚¨çš„ APP IDï¼Œæ–¹ä¾¿è³‡æ–™å€éš”
        // =================================================================================

        const apiKey = "AIzaSyChWE_r98G1FoQ0Irc-hdUs_rtrpnaDtP4"; // Gemini API Key (æ³¨æ„: æ­¤ç‚ºå…¬é–‹ Key)
        let app, db, auth, userId;
        let appId, firebaseConfig, initialAuthToken;

        // --- Config Detection Logic ---
        function detectConfig() {
            // 1. å˜—è©¦è®€å–æ³¨å…¥çš„ç’°å¢ƒè®Šæ•¸ (Preview ç’°å¢ƒ)
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
                initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                console.log("Using injected config (Preview Mode)");
                return true;
            }
            
            // 2. å˜—è©¦è®€å–æ‰‹å‹•è¨­å®š (GitHub / Standalone)
            if (MANUAL_FIREBASE_CONFIG.apiKey) {
                firebaseConfig = MANUAL_FIREBASE_CONFIG;
                appId = MANUAL_APP_ID;
                initialAuthToken = null; // GitHub ç„¡æ³•ä½¿ç”¨é å…ˆç°½ç½²çš„ token
                console.log("Using manual config (Production Mode)");
                return true;
            }

            // 3. å˜—è©¦è®€å– LocalStorage å¿«å– (é¿å…æ¯æ¬¡éƒ½è¦è¼¸å…¥)
            const cachedConfig = localStorage.getItem('japan_trip_firebase_config');
            if (cachedConfig) {
                try {
                    firebaseConfig = JSON.parse(cachedConfig);
                    appId = localStorage.getItem('japan_trip_app_id') || 'my-japan-trip-cached';
                    console.log("Using cached config");
                    return true;
                } catch(e) {
                    console.error("Invalid cached config", e);
                    localStorage.removeItem('japan_trip_firebase_config');
                }
            }

            return false;
        }

        window.state = {
            tripTitle: 'ğŸŒ¸ æ—¥æœ¬æ—…éŠè¦åŠƒå™¨',
            itineraries: [],
            expenses: [],
            participants: [], 
            shoppingList: [], 
            travelDetails: { participantsDetails: [], flight: {}, hotel: {} },
            packingList: { outbound: [], inbound: [] },
            expenseSummary: { grossPaidTWD: {}, netSettlement: {} },
            JPY_TO_TWD_RATE: 0.2200,
            customShopTargets: JSON.parse(localStorage.getItem('custom_shop_targets') || '[]'),
            currentPackTab: 'outbound'
        };

        const $ = (id) => document.getElementById(id);
        const DOM = {
            appIdDisplay: $('app-id-display'),
            toastContainer: $('toast-container'),
            currentUserSelect: $('current-user-select'),
            currentUserName: $('current-user-name'),
            currentUserBadge: $('current-user-badge'),
            tripTitleDisplay: $('trip-title-display')
        };
        
        // --- SETTINGS & EXPORT & ARCHIVE ---
        window.showSettingsModal = () => {
             const html = `
                <div id="modal-settings" class="modal-enter fixed inset-0 bg-black/80 flex items-center justify-center z-[90] p-4">
                    <div class="card-bg w-full max-w-md rounded-2xl p-5 shadow-2xl border border-slate-600">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-white flex items-center">
                                <i data-lucide="settings" class="w-5 h-5 mr-2"></i> è¨­å®šèˆ‡å·¥å…·
                            </h3>
                            <button onclick="window.closeModal('modal-settings')" class="text-slate-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                        
                        <div class="space-y-6">
                            <!-- 1. æ›´æ”¹æ¨™é¡Œ -->
                            <div class="border-b border-slate-700 pb-4">
                                <label class="block text-xs text-secondary mb-2">æ›´æ”¹æ—…éŠæ¨™é¡Œ</label>
                                <div class="flex gap-2">
                                    <input type="text" id="setting-title" value="${window.state.tripTitle}" class="flex-1 bg-slate-800 border-slate-600 rounded-lg p-2 text-white text-sm" placeholder="ä¾‹å¦‚: 2024 æ±äº¬è‡ªç”±è¡Œ">
                                    <button onclick="window.saveTitleSetting()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 rounded-lg text-sm whitespace-nowrap">å„²å­˜</button>
                                </div>
                            </div>

                            <!-- 2. åŒ¯å‡ºè³‡æ–™ -->
                            <div class="border-b border-slate-700 pb-4">
                                <label class="block text-xs text-secondary mb-2">åŒ¯å‡ºè³‡æ–™ (Excel/CSV)</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <button onclick="window.exportData('itinerary')" class="py-2 bg-slate-700 hover:bg-slate-600 text-sky-300 rounded-lg text-sm flex items-center justify-center border border-slate-600">
                                        <i data-lucide="map-pin" class="w-4 h-4 mr-2"></i> åŒ¯å‡ºè¡Œç¨‹
                                    </button>
                                    <button onclick="window.exportData('shopping')" class="py-2 bg-slate-700 hover:bg-slate-600 text-pink-300 rounded-lg text-sm flex items-center justify-center border border-slate-600">
                                        <i data-lucide="shopping-bag" class="w-4 h-4 mr-2"></i> åŒ¯å‡ºè³¼ç‰©
                                    </button>
                                    <button onclick="window.exportData('accounting')" class="py-2 bg-slate-700 hover:bg-slate-600 text-green-300 rounded-lg text-sm flex items-center justify-center border border-slate-600">
                                        <i data-lucide="wallet" class="w-4 h-4 mr-2"></i> åŒ¯å‡ºè¨˜å¸³
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 3. é‡è¨­ Config (å¦‚æœæ˜¯åœ¨ GitHub ä¸Š) -->
                            <div class="border-b border-slate-700 pb-4">
                                <label class="block text-xs text-secondary mb-2">ç³»çµ±é€£ç·šè¨­å®š</label>
                                <button onclick="window.resetFirebaseConfig()" class="w-full py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 border border-slate-600 rounded-lg text-sm transition">
                                    é‡è¨­ Firebase é€£ç·šè³‡è¨Š
                                </button>
                            </div>

                            <!-- 4. å°å­˜/é‡ç½® -->
                            <div>
                                <label class="block text-xs text-red-400 mb-2 font-bold">å±éšªå€åŸŸ</label>
                                <button onclick="window.archiveTrip()" class="w-full py-3 bg-red-900/30 hover:bg-red-900/50 text-red-400 border border-red-800 rounded-lg text-sm flex items-center justify-center transition">
                                    <i data-lucide="archive" class="w-4 h-4 mr-2"></i> å°å­˜æ­¤æ¬¡æ—…è¡Œ (åŒ¯å‡ºä¸¦é‡ç½®)
                                </button>
                                <p class="text-[10px] text-slate-500 mt-2 text-center">æ³¨æ„ï¼šé€™å°‡ä¸‹è¼‰æ‰€æœ‰è³‡æ–™å‚™ä»½ï¼Œç„¶å¾Œæ¸…ç©º APP å…§çš„æ‰€æœ‰è¨˜éŒ„ï¼Œè®“æ‚¨é–‹å§‹æ–°çš„æ—…ç¨‹ã€‚</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            window.openModal(html);
        }

        window.saveTitleSetting = () => {
            const newTitle = $('setting-title').value.trim();
            if(newTitle) {
                window.state.tripTitle = newTitle;
                saveData('tripTitle', newTitle);
                DOM.tripTitleDisplay.textContent = newTitle;
                showToast('æ¨™é¡Œå·²æ›´æ–°');
            }
        }
        
        window.resetFirebaseConfig = () => {
            if (confirm("ç¢ºå®šè¦é‡è¨­é€£ç·šè³‡è¨Šå—ï¼Ÿé€™æœƒæ¸…é™¤æ‚¨ç›®å‰ç€è¦½å™¨å„²å­˜çš„ Firebase è¨­å®šã€‚")) {
                localStorage.removeItem('japan_trip_firebase_config');
                window.location.reload();
            }
        }

        window.exportData = (type) => {
            let csvContent = "\uFEFF"; // BOM for Excel encoding
            let filename = `JapanTrip_${type}.csv`;
            
            if (type === 'itinerary') {
                csvContent += "Day,Time,Type,Title,Note,Address,URL,Booked\n";
                window.state.itineraries.sort((a,b) => (a.day-b.day)||(a.startTime||'').localeCompare(b.startTime||'')).forEach(i => {
                    const row = [
                        i.day, i.startTime, i.type, `"${(i.title||'').replace(/"/g,'""')}"`, 
                        `"${(i.note||'').replace(/"/g,'""')}"`, `"${(i.address||'').replace(/"/g,'""')}"`, 
                        i.url, i.isBooked?'Yes':'No'
                    ];
                    csvContent += row.join(",") + "\n";
                });
            } else if (type === 'shopping') {
                csvContent += "Item,Price(JPY),TotalQty,IsBought,Buyers,Note,URL\n";
                window.state.shoppingList.forEach(i => {
                    const buyersStr = (i.buyers||[]).map(b => `${b.name}(${b.qty})`).join('; ');
                    const totalQty = (i.buyers||[]).reduce((s,b)=>s+b.qty, 0);
                    const row = [
                        `"${(i.name||'').replace(/"/g,'""')}"`, i.price, totalQty, i.isBought?'Yes':'No',
                        `"${buyersStr}"`, `"${(i.note||'').replace(/"/g,'""')}"`, i.url
                    ];
                    csvContent += row.join(",") + "\n";
                });
            } else if (type === 'accounting') {
                csvContent += "Description,Amount,Currency,Payer,Method,GroupSplit,Details\n";
                window.state.expenses.forEach(e => {
                     const detailStr = e.isGroup ? (e.splitDetails||[]).map(d => `${d.name}:${d.amount}`).join('; ') : '';
                     const row = [
                        `"${(e.description||'').replace(/"/g,'""')}"`, e.amount, e.currency, e.payer,
                        e.paymentMethod, e.isGroup?'Yes':'No', `"${detailStr}"`
                     ];
                     csvContent += row.join(",") + "\n";
                });
            }

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showToast(`${filename} ä¸‹è¼‰å®Œæˆ`);
            }
        }

        window.archiveTrip = () => {
            window.showConfirm("æ‚¨ç¢ºå®šè¦å°å­˜æ­¤æ¬¡æ—…è¡Œå—ï¼Ÿ\n\nç³»çµ±å°‡è‡ªå‹•ä¸‹è¼‰ 3 ä»½ CSV å‚™ä»½æª”æ¡ˆ (è¡Œç¨‹ã€è³¼ç‰©ã€è¨˜å¸³)ï¼Œç„¶å¾Œã€Œæ¸…ç©ºã€æ‰€æœ‰è³‡æ–™ä»¥ä¾¿æ‚¨è¦åŠƒæ–°çš„æ—…ç¨‹ã€‚", async () => {
                showToast('æ­£åœ¨å‚™ä»½è³‡æ–™...', 'info');
                
                // Trigger downloads
                window.exportData('itinerary');
                await new Promise(r => setTimeout(r, 500));
                window.exportData('shopping');
                await new Promise(r => setTimeout(r, 500));
                window.exportData('accounting');
                
                await new Promise(r => setTimeout(r, 1500)); // wait for downloads
                
                // Reset State
                const emptyState = {
                    tripTitle: 'æ–°çš„æ—¥æœ¬ä¹‹æ—…',
                    itineraries: [],
                    expenses: [],
                    shoppingList: [],
                    // Keep participants? Maybe better to reset them too for a truly new trip, 
                    // or keep them? "Archive" usually implies starting fresh. Let's keep participants for convenience but clear transaction data.
                    // Actually, let's clear everything but maybe keep the current user setting.
                    participants: [], 
                    travelDetails: { participantsDetails: [], flight: {}, hotel: {} },
                    packingList: { outbound: [], inbound: [] },
                    customShopTargets: []
                };

                try {
                    // Update Firestore with empty state
                    await setDoc(doc(db, 'artifacts', appId, 'users', userId, 'japan_trip', 'data'), emptyState);
                    showToast('æ—…è¡Œå·²å°å­˜ä¸¦é‡ç½®ï¼', 'success');
                    window.closeModal('modal-settings');
                } catch(e) {
                    console.error(e);
                    showToast('é‡ç½®å¤±æ•—', 'error');
                }
            });
        }

        // --- CUSTOM CONFIRM MODAL (REPLACES BROWSER CONFIRM) ---
        window.showConfirm = (text, onConfirm) => {
            const modalId = 'modal-confirm-' + Date.now();
            // Replacing newlines with <br> for better formatting in HTML
            const formattedText = text.replace(/\n/g, '<br>');
            const html = `
                <div id="${modalId}" class="modal-enter fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4">
                    <div class="card-bg w-full max-w-sm rounded-2xl p-6 shadow-2xl border border-slate-600 relative animate-bounce-in">
                        <div class="text-center">
                            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-900/50 mb-4">
                                <i data-lucide="alert-triangle" class="w-6 h-6 text-red-500"></i>
                            </div>
                            <h3 class="text-lg font-bold text-white mb-2">ç¢ºèªæ“ä½œ</h3>
                            <p class="text-slate-300 text-sm mb-6 leading-relaxed">${formattedText}</p>
                            <div class="grid grid-cols-2 gap-3">
                                <button id="btn-cancel-${modalId}" class="py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition">å–æ¶ˆ</button>
                                <button id="btn-confirm-${modalId}" class="py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold transition shadow-lg shadow-red-900/20">ç¢ºèª</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const div = document.createElement('div');
            div.innerHTML = html;
            document.body.appendChild(div);
            
            const modalEl = document.getElementById(modalId);
            requestAnimationFrame(() => {
                modalEl.classList.add('modal-enter-active');
            });

            const cleanup = () => {
                modalEl.classList.remove('modal-enter-active');
                setTimeout(() => div.remove(), 200);
            };

            document.getElementById(`btn-cancel-${modalId}`).onclick = cleanup;
            document.getElementById(`btn-confirm-${modalId}`).onclick = () => {
                onConfirm();
                cleanup();
            };
            
            if (window.lucide) window.lucide.createIcons();
        }
        
        // --- SHOW SETUP MODAL ---
        window.showSetupModal = () => {
            const html = `
                <div id="modal-setup" class="fixed inset-0 bg-black flex items-center justify-center z-[100] p-4">
                    <div class="card-bg w-full max-w-md rounded-2xl p-6 shadow-2xl border border-blue-500">
                        <div class="text-center mb-6">
                            <h2 class="text-xl font-bold text-white mb-2">ğŸš€ åˆå§‹åŒ–è¨­å®š</h2>
                            <p class="text-slate-400 text-sm">åµæ¸¬åˆ°æ‚¨æ­£åœ¨ GitHub/å¤–éƒ¨ç’°å¢ƒåŸ·è¡Œã€‚</p>
                            <p class="text-slate-400 text-sm">è«‹è¼¸å…¥æ‚¨çš„ Firebase è¨­å®šä»¥å•Ÿå‹• Appã€‚</p>
                        </div>
                        <form id="setup-form" class="space-y-4">
                            <textarea id="setup-json" rows="8" placeholder='è«‹è²¼ä¸Š Firebase Config JSONï¼Œä¾‹å¦‚ï¼š
{
  "apiKey": "...",
  "authDomain": "...",
  "projectId": "..."
}' class="w-full bg-slate-800 border-slate-600 rounded-lg p-3 text-white text-xs font-mono"></textarea>
                            
                            <div class="bg-blue-900/20 p-3 rounded border border-blue-800 text-xs text-blue-200">
                                ğŸ’¡ æç¤ºï¼šæ‚¨å¯ä»¥å°‡è¨­å®šç›´æ¥å¯«å…¥ index.html çš„ <code>MANUAL_FIREBASE_CONFIG</code> è®Šæ•¸ä¸­ï¼Œå³å¯è·³éæ­¤æ­¥é©Ÿã€‚
                            </div>

                            <button type="submit" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-lg transition">å•Ÿå‹• App</button>
                        </form>
                    </div>
                </div>
            `;
            const div = document.createElement('div');
            div.innerHTML = html;
            document.body.appendChild(div);
            
            document.getElementById('setup-form').onsubmit = (e) => {
                e.preventDefault();
                try {
                    const jsonStr = document.getElementById('setup-json').value;
                    const config = JSON.parse(jsonStr);
                    if(!config.apiKey || !config.projectId) throw new Error("ç¼ºå°‘å¿…è¦æ¬„ä½");
                    
                    localStorage.setItem('japan_trip_firebase_config', JSON.stringify(config));
                    localStorage.setItem('japan_trip_app_id', 'my-japan-trip-manual');
                    
                    showToast("è¨­å®šå·²å„²å­˜ï¼Œæ­£åœ¨é‡æ–°æ•´ç†...");
                    setTimeout(() => window.location.reload(), 1000);
                } catch(err) {
                    alert("è¨­å®šæ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºä¿æ˜¯æœ‰æ•ˆçš„ JSONã€‚\n" + err.message);
                }
            };
        }

        // --- GEMINI HELPER ---
        async function callGemini(prompt, imageBase64 = null) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const parts = [{ text: prompt }];
            if (imageBase64) {
                const base64Data = imageBase64.split(',')[1] || imageBase64;
                parts.push({ inlineData: { mimeType: "image/jpeg", data: base64Data } });
            }
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: parts }] })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (error) {
                console.error("Gemini Error:", error);
                throw error;
            }
        }

        // --- AI FEATURES ---
        window.showAiPlanModal = () => {
            const html = `
                <div id="modal-ai-plan" class="modal-enter fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                    <div class="card-bg w-full max-w-md rounded-2xl p-5 shadow-2xl">
                        <h3 class="text-lg font-bold text-white mb-4">âœ¨ AI è¡Œç¨‹è¦åŠƒ</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="text-xs text-secondary">ç¬¬å¹¾å¤©</label>
                                <input type="number" id="ai-day" value="1" min="1" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-white">
                            </div>
                            <div>
                                <label class="text-xs text-secondary">æƒ³å»å“ªè£¡ / é¢¨æ ¼ (ä¾‹å¦‚: äº¬éƒ½æ¸…æ°´å¯ºã€ç¾é£Ÿä¹‹æ—…)</label>
                                <input type="text" id="ai-prompt" placeholder="è¼¸å…¥åœ°é»æˆ–é¢¨æ ¼" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-white">
                            </div>
                            <button onclick="window.generateItinerary()" class="w-full py-3 bg-purple-600 text-white rounded-lg font-bold mt-2">é–‹å§‹ç”Ÿæˆ</button>
                            <button onclick="window.closeModal('modal-ai-plan')" class="w-full py-2 bg-slate-700 text-white rounded-lg mt-2">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            `;
            window.openModal(html);
        }

        window.generateItinerary = async () => {
            const day = parseInt($('ai-day').value) || 1;
            const userPrompt = $('ai-prompt').value;
            if (!userPrompt) return showToast('è«‹è¼¸å…¥åœ°é»æˆ–é¢¨æ ¼', 'error');

            window.closeModal('modal-ai-plan');
            showToast('AI æ­£åœ¨è¦åŠƒä¸­ï¼Œè«‹ç¨å€™...', 'info');

            try {
                const prompt = `Please generate 3-4 itinerary items for a trip to "${userPrompt}". Return a JSON array where each object has: title (string), type (one of: meal, museum, shopping, hotel, station, sightseeing), durationMinutes (int), note (string, short description). No markdown, just JSON.`;
                const result = await callGemini(prompt);
                const cleanJson = result.replace(/```json|```/g, '').trim();
                const items = JSON.parse(cleanJson);

                let currentTime = 9 * 60; // Start at 09:00
                items.forEach(item => {
                    const h = Math.floor(currentTime / 60);
                    const m = currentTime % 60;
                    const timeStr = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    
                    window.state.itineraries.push({
                        id: Date.now() + Math.random(),
                        day: day,
                        startTime: timeStr,
                        type: item.type || 'sightseeing',
                        title: item.title,
                        note: item.note,
                        isBooked: false,
                        order: Date.now()
                    });
                    currentTime += (item.durationMinutes || 60) + 30; // Add duration + buffer
                });

                saveData('itineraries', window.state.itineraries);
                showToast('è¡Œç¨‹ç”Ÿæˆå®Œç•¢ï¼', 'success');
            } catch (e) {
                console.error(e);
                showToast('ç”Ÿæˆå¤±æ•—ï¼Œè«‹é‡è©¦', 'error');
            }
        }

        window.triggerGeminiReceipt = () => $('receipt-upload').click();
        window.handleReceiptUpload = async (input) => {
            const file = input.files[0];
            if (!file) return;
            showToast("AI æ­£åœ¨åˆ†ææ”¶æ“š...è«‹ç¨å€™", "info");
            const reader = new FileReader();
            reader.onload = async (e) => {
                const img = new Image();
                img.onload = async () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxSize = 1024;
                    let width = img.width, height = img.height;
                    if (width > height) { if (width > maxSize) { height *= maxSize/width; width = maxSize; } } else { if (height > maxSize) { width *= maxSize/height; height = maxSize; } }
                    canvas.width = width; canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    const compressedBase64 = canvas.toDataURL('image/jpeg', 0.8);
                    try {
                        const prompt = "ä½ æ˜¯ä¸€å€‹æ—¥æœ¬æ—…éŠåŠ©æ‰‹ã€‚è«‹åˆ†æé€™å¼µæ”¶æ“šåœ–ç‰‡ã€‚æå–ç¸½é‡‘é¡(amount)ã€å¹£åˆ¥(currencyï¼ŒJPY/TWD)ã€ä»¥åŠæ‘˜è¦(description)ã€‚åªå›å‚³JSONæ ¼å¼ï¼š{ \"amount\": 123, \"currency\": \"JPY\", \"description\": \"...\" }ã€‚ç„¡markdownã€‚";
                        const result = await callGemini(prompt, compressedBase64);
                        const cleanJson = result.replace(/```json|```/g, '').trim();
                        const data = JSON.parse(cleanJson);
                        window.showAddExpenseModal();
                        setTimeout(() => {
                            if(data.amount) $('expense-amount').value = data.amount;
                            if(data.currency) document.querySelector(`select[name="currency"]`).value = data.currency;
                            if(data.description) document.querySelector(`input[name="desc"]`).value = data.description;
                            showToast("AI åˆ†æå®Œæˆï¼", "success");
                        }, 500);
                    } catch (e) { showToast("AI åˆ†æå¤±æ•—", "error"); }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
            input.value = '';
        }

        window.generateAIPackingList = async () => {
            const tab = window.state.currentPackTab;
            if (window.state.packingList[tab].length > 0) {
                return new Promise(resolve => {
                    window.showConfirm("æ¸…å–®å·²æœ‰é …ç›®ï¼Œç¢ºå®šè¦åŠ å…¥æ–°æ¨è–¦å—ï¼Ÿ", async () => {
                        await _doGenAIList(tab);
                        resolve();
                    });
                });
            } else {
                await _doGenAIList(tab);
            }
        }
        
        async function _doGenAIList(tab) {
            showToast("AI æ­£åœ¨æ€è€ƒå¿…å‚™æ¸…å–®...", "info");
            try {
                const type = tab === 'outbound' ? "å»æ—¥æœ¬æ—…éŠ (å‡ºåœ‹å‰)" : "å›å°ç£ (å›åœ‹å‰)";
                const prompt = `åˆ—å‡º 5-8 é … ${type} å¿…å‚™æª¢æŸ¥æ¸…å–®ã€‚åªå›å‚³ JSON å­—ä¸²é™£åˆ—ï¼š["é …ç›®1", "é …ç›®2"]ã€‚ç„¡markdownã€‚`;
                const result = await callGemini(prompt);
                const items = JSON.parse(result.replace(/```json|```/g, '').trim());
                items.forEach(text => window.state.packingList[tab].push({ id: Date.now() + Math.random(), text: text, checked: false }));
                saveData('packingList', window.state.packingList);
                showToast("æ¸…å–®å·²ç”Ÿæˆï¼", "success");
            } catch (e) { showToast("AI ç”Ÿæˆå¤±æ•—", "error"); }
        }

        // --- Firebase Initialization ---
        async function initApp() {
            const hasConfig = detectConfig();
            
            if (!hasConfig) {
                // å¦‚æœæ²’æœ‰è¨­å®šï¼Œé¡¯ç¤º Setup Modal
                window.showSetupModal();
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                DOM.appIdDisplay.textContent = appId;

                onAuthStateChanged(auth, async (user) => {
                    if (user) { 
                        userId = user.uid; 
                        listenToData(); 
                    } else { 
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                // GitHub ç’°å¢ƒä½¿ç”¨åŒ¿åç™»å…¥
                                await signInAnonymously(auth);
                            }
                        } catch (err) {
                            console.error("Auth Error", err);
                            alert("Firebase é©—è­‰å¤±æ•—ã€‚è«‹ç¢ºèªæ‚¨çš„ Firebase Console ä¸­å·²é–‹å•Ÿã€ŒåŒ¿åç™»å…¥ (Anonymous Auth)ã€åŠŸèƒ½ã€‚\n" + err.message);
                        }
                    }
                });
            } catch (e) { 
                console.error("Firebase Init Error", e);
                alert("Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¨­å®šæ˜¯å¦æ­£ç¢ºã€‚\n" + e.message);
                window.showSetupModal(); // é‡è©¦è¨­å®š
            }
        }

        function listenToData() {
            const ref = doc(db, 'artifacts', appId, 'users', userId, 'japan_trip', 'data');
            onSnapshot(ref, (docSnap) => {
                $('itinerary-loading').classList.add('hidden');
                $('expense-loading').classList.add('hidden');
                $('shopping-loading').classList.add('hidden');
                
                if (docSnap.exists()) {
                    const d = docSnap.data();
                    window.state.tripTitle = d.tripTitle || 'ğŸŒ¸ æ—¥æœ¬æ—…éŠè¦åŠƒå™¨';
                    window.state.itineraries = d.itineraries || [];
                    window.state.expenses = d.expenses || [];
                    window.state.shoppingList = d.shoppingList || [];
                    window.state.participants = d.participants || [];
                    window.state.travelDetails = d.travelDetails || { participantsDetails: [], flight: {}, hotel: {} };
                    if(d.customShopTargets) {
                        window.state.customShopTargets = d.customShopTargets;
                        localStorage.setItem('custom_shop_targets', JSON.stringify(d.customShopTargets));
                    }
                    const pl = d.packingList || { outbound: [], inbound: [] };
                    if (!pl.outbound) pl.outbound = [];
                    if (!pl.inbound) pl.inbound = [];
                    window.state.packingList = pl;
                } else { setDoc(ref, window.state, { merge: true }); }
                renderAll();
            }, (error) => {
                console.error("Snapshot error:", error);
                if (error.code === 'permission-denied') {
                    showToast("æ¬Šé™éŒ¯èª¤ï¼šè«‹ç¢ºèª Firebase Firestore Rules å·²è¨­å®šç‚ºå…¬é–‹æˆ–æ­£ç¢ºã€‚", "error");
                }
            });
        }

        async function saveData(key, value) {
            if (!userId) return;
            try { await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'japan_trip', 'data'), { [key]: value }); showToast('è³‡æ–™å·²å„²å­˜'); } 
            catch(e) { console.error(e); showToast('å„²å­˜å¤±æ•—', 'error'); }
        }

        function renderAll() {
            DOM.tripTitleDisplay.textContent = window.state.tripTitle; // Update title
            renderExpensesAndCalc();
            renderItineraries();
            renderShoppingList();
            renderParticipants();
            renderDetailedParticipants();
            renderFlight();
            renderHotelInfo();
            renderPackingList();
            renderCurrentUserSelect();
            renderProxyList();
            updateIcons();
            
            const savedCity = localStorage.getItem('weather_city');
            if(savedCity) {
                $('weather-city').value = savedCity;
                window.fetchWeather(); 
            }
            $('rate-display').textContent = window.state.JPY_TO_TWD_RATE;
        }

        function updateIcons() { if (window.lucide && window.lucide.createIcons) window.lucide.createIcons(); }
        window.copyText = (text) => {
            if (!text) return;
            if (navigator.clipboard) navigator.clipboard.writeText(text).then(()=>showToast(`å·²è¤‡è£½: ${text}`));
            else {
                const ta = document.createElement("textarea"); ta.value = text; document.body.appendChild(ta); ta.select();
                document.execCommand('copy'); document.body.removeChild(ta); showToast(`å·²è¤‡è£½: ${text}`);
            }
        }

        // --- Renderers ---
        // ITINERARY
        window.showAddItineraryModal = function(idx = -1) {
            const item = idx > -1 ? window.state.itineraries[idx] : { day: 1, type: 'meal' };
            window.openModal(`
                <div id="modal-itin" class="modal-enter fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                    <div class="card-bg w-full max-w-md rounded-2xl p-5 shadow-2xl max-h-[90vh] overflow-y-auto">
                        <h3 class="text-lg font-bold text-white mb-4">${idx > -1 ? 'ç·¨è¼¯' : 'æ–°å¢'}è¡Œç¨‹</h3>
                        <form id="form-itin" class="space-y-3">
                            <div class="flex gap-2">
                                <div class="w-20">
                                    <label class="text-xs text-secondary">Day</label>
                                    <input type="number" name="day" value="${item.day}" class="w-full bg-slate-800 border-slate-600 rounded-lg p-2 text-white" required>
                                </div>
                                <div class="flex-1">
                                    <label class="text-xs text-secondary">åœ°é»åç¨±</label>
                                    <input type="text" id="itin-title" name="title" placeholder="åœ°é»åç¨±" value="${item.title || ''}" class="w-full bg-slate-800 border-slate-600 rounded-lg p-2 text-white" required>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-secondary font-bold text-sky-400">æ™‚é–“ (24h)</label>
                                <input type="time" name="startTime" value="${item.startTime || ''}" step="600" class="w-full bg-slate-800 border-slate-600 rounded-lg p-2 text-white">
                            </div>
                            <div class="flex items-center gap-2 pt-1">
                                <input type="checkbox" name="isBooked" id="isBooked" class="w-5 h-5 rounded text-purple-500 focus:ring-0 bg-slate-800 border-slate-500" ${item.isBooked ? 'checked' : ''}>
                                <label for="isBooked" class="text-sm text-purple-300 font-bold">å·²é ç´„æ­¤è¡Œç¨‹</label>
                            </div>
                            <div>
                                <label class="text-xs text-secondary">é¡å‹</label>
                                <select name="type" class="w-full bg-slate-800 border-slate-600 rounded-lg p-2 text-white mt-1">
                                    <option value="meal" ${item.type === 'meal' ? 'selected' : ''}>ğŸ½ï¸ åƒé£¯</option>
                                    <option value="museum" ${item.type === 'museum' ? 'selected' : ''}>ğŸ¨ ç¾è¡“é¤¨</option>
                                    <option value="shopping" ${item.type === 'shopping' ? 'selected' : ''}>ğŸ›ï¸ è³¼ç‰©</option>
                                    <option value="hotel" ${item.type === 'hotel' ? 'selected' : ''}>ğŸ¨ é£¯åº—</option>
                                    <option value="station" ${item.type === 'station' ? 'selected' : ''}>ğŸš‰ è»Šç«™</option>
                                    <option value="sightseeing" ${item.type === 'sightseeing' ? 'selected' : ''}>ğŸ“¸ è§€å…‰æ™¯é»</option>
                                </select>
                            </div>
                            <input type="text" id="itin-url" name="url" placeholder="Google Maps ç¶²å€" value="${item.url || ''}" class="w-full bg-slate-800 border-slate-600 rounded-lg p-2 text-white">
                            <button type="button" id="btn-fetch" class="w-full py-2 bg-blue-900/50 text-blue-300 text-xs rounded border border-blue-800">è‡ªå‹•æŠ“å–è³‡è¨Š (æ¨¡æ“¬)</button>
                            <input type="text" id="itin-rating" name="rating" placeholder="è©•åˆ† (é¸å¡«)" value="${item.rating || ''}" class="w-full bg-slate-800 border-slate-600 rounded-lg p-2 text-white">
                            <input type="text" id="itin-address" name="address" placeholder="åœ°å€" value="${item.address || ''}" class="w-full bg-slate-800 border-slate-600 rounded-lg p-2 text-white">
                            <textarea id="itin-note" name="note" rows="2" placeholder="å‚™è¨»" class="w-full bg-slate-800 border-slate-600 rounded-lg p-2 text-white">${item.note || ''}</textarea>
                            <div class="flex gap-3 pt-4">
                                <button type="button" onclick="window.closeModal('modal-itin')" class="flex-1 py-3 text-slate-400 bg-slate-800 rounded-lg">å–æ¶ˆ</button>
                                <button type="submit" class="flex-1 py-3 bg-sky-600 text-white rounded-lg font-bold">å„²å­˜</button>
                            </div>
                        </form>
                    </div>
                </div>
            `);
            $('btn-fetch').onclick = async () => { $('btn-fetch').textContent='è®€å–ä¸­...'; await new Promise(r=>setTimeout(r,800)); $('itin-title').value = 'æ¨¡æ“¬åœ°é»'; $('btn-fetch').textContent='è‡ªå‹•æŠ“å–è³‡è¨Š (æ¨¡æ“¬)'; };
            $('form-itin').onsubmit = (e) => { 
                e.preventDefault(); const f = e.target; 
                const newItem = { 
                    id: item.id || Date.now(), 
                    day: parseInt(f.day.value), 
                    startTime: f.startTime.value, 
                    type: f.type.value, 
                    isBooked: f.isBooked.checked,
                    url: f.url.value, title: f.title.value, rating: f.rating.value, 
                    address: f.address.value, note: f.note.value, 
                    order: item.order || Date.now() 
                }; 
                if(idx > -1) window.state.itineraries[idx] = newItem; else window.state.itineraries.push(newItem); 
                saveData('itineraries', window.state.itineraries); window.closeModal('modal-itin'); 
            };
        }

        function renderItineraries() {
            const list = window.state.itineraries.sort((a,b) => {
                if(a.day !== b.day) return a.day - b.day;
                if(a.startTime && b.startTime) return a.startTime.localeCompare(b.startTime);
                return a.order - b.order;
            });
            const container = $('itinerary-days-container'); container.innerHTML = '';
            if(list.length === 0) $('itinerary-empty').classList.remove('hidden'); else $('itinerary-empty').classList.add('hidden');
            
            const grouped = {}; list.forEach(i => { if(!grouped[i.day]) grouped[i.day] = []; grouped[i.day].push(i); });
            
            for(let day in grouped) {
                const div = document.createElement('div');
                div.innerHTML = `<h3 class="text-lg font-bold text-white mb-2 pl-2 border-l-4 border-sky-500">Day ${day}</h3>`;
                const ul = document.createElement('ul'); ul.className = 'space-y-4 mb-6 relative';
                
                grouped[day].forEach((item) => {
                    const timeDisplay = item.startTime || '--:--';
                    const li = document.createElement('li');
                    li.className = 'card-bg rounded-xl p-4 border border-slate-700 shadow relative z-10';
                    li.innerHTML = `
                        <div class="flex gap-3 relative">
                            <div class="flex flex-col items-center pt-1 w-12 shrink-0">
                                <span class="text-sm text-sky-400 font-bold">${timeDisplay}</span>
                            </div>
                            <div class="flex-1 pb-1 min-w-0">
                                <h4 class="text-lg font-bold text-white truncate pr-2 flex items-center">
                                    ${item.title}
                                    ${item.isBooked ? `<span class="ml-2 bg-purple-600 text-white text-[10px] px-2 py-0.5 rounded-full shadow">å·²é ç´„</span>` : ''}
                                </h4>
                                <div class="flex flex-wrap gap-2 mt-1 text-xs text-secondary"></div>
                                ${item.address ? `<a href="${item.url||'#'}" target="_blank" class="nav-link flex items-center mt-1 text-xs"><i data-lucide="map-pin" class="w-3 h-3 mr-1"></i> ${item.address}</a>` : ''}
                                ${item.note ? `<div class="mt-2 text-xs text-slate-300 bg-slate-800 p-2 rounded leading-relaxed whitespace-pre-wrap">${item.note}</div>` : ''}
                            </div>
                            <div class="flex flex-col justify-start items-center gap-2 ml-1">
                                <button onclick="window.editItin('${item.id}')" class="w-8 h-8 flex items-center justify-center text-blue-400 bg-slate-800 rounded hover:bg-slate-700"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                                <button onclick="window.delItin('${item.id}')" class="w-8 h-8 flex items-center justify-center text-red-400 bg-slate-800 rounded hover:bg-slate-700"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    `;
                    ul.appendChild(li);
                });
                div.appendChild(ul); container.appendChild(div);
            }
            updateIcons();
        }
        window.editItin = (id) => { const idx = window.state.itineraries.findIndex(i => i.id == id); window.showAddItineraryModal(idx); }
        
        // FIXED DEL ITIN
        window.delItin = (id) => {
             window.showConfirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¡Œç¨‹å—ï¼Ÿ', () => {
                 const idx = window.state.itineraries.findIndex(i => i.id == id);
                 if(idx > -1) {
                     window.state.itineraries.splice(idx, 1);
                     saveData('itineraries', window.state.itineraries); 
                 }
             });
        }

        // PACKING
        window.deletePackItem = (tab, index) => {
            window.showConfirm('ç¢ºå®šè¦ç§»é™¤æ­¤æ¸…å–®é …ç›®ï¼Ÿ', () => {
                window.state.packingList[tab].splice(index, 1);
                saveData('packingList', window.state.packingList);
                renderPackingList();
            });
        }
        
        // FIXED EDIT PACK ITEM (Custom Prompt)
        window.editPackItem = (tab, index) => {
            const list = window.state.packingList;
            const oldVal = list[tab][index].text;
            
            const html = `
                <div id="modal-prompt" class="modal-enter fixed inset-0 bg-black/80 flex items-center justify-center z-[80] p-4">
                    <div class="card-bg w-full max-w-sm rounded-2xl p-5 shadow-2xl border border-slate-600">
                        <h3 class="text-lg font-bold text-white mb-4">ç·¨è¼¯é …ç›®</h3>
                        <input type="text" id="prompt-input" value="${oldVal}" class="w-full bg-slate-800 border-slate-600 rounded-lg p-3 text-white mb-4">
                        <div class="flex gap-3">
                            <button id="btn-prompt-cancel" class="flex-1 py-2 bg-slate-700 text-white rounded-lg">å–æ¶ˆ</button>
                            <button id="btn-prompt-ok" class="flex-1 py-2 bg-blue-600 text-white rounded-lg font-bold">å„²å­˜</button>
                        </div>
                    </div>
                </div>
            `;
            const div = document.createElement('div');
            div.innerHTML = html;
            document.body.appendChild(div);
            
            const inp = document.getElementById('prompt-input');
            const cancelBtn = document.getElementById('btn-prompt-cancel');
            const okBtn = document.getElementById('btn-prompt-ok');
            
            setTimeout(() => {
                document.getElementById('modal-prompt').classList.add('modal-enter-active');
                inp.focus();
            }, 50);

            const close = () => {
                document.getElementById('modal-prompt').classList.remove('modal-enter-active');
                setTimeout(() => div.remove(), 200);
            }

            cancelBtn.onclick = close;
            okBtn.onclick = () => {
                const newVal = inp.value;
                if (newVal && newVal.trim() !== "") {
                    list[tab][index].text = newVal.trim();
                    saveData('packingList', list);
                    renderPackingList();
                }
                close();
            };
        }

        // WEATHER
        window.saveWeatherCity = () => {
            const city = $('weather-city').value;
            localStorage.setItem('weather_city', city);
            window.fetchWeather();
        }
        window.fetchWeather = async () => {
            const city = $('weather-city').value;
            const cityName = $('weather-city').options[$('weather-city').selectedIndex].text;
            const container = document.getElementById('weather-container');
            if(!container) return;
            
            container.innerHTML = '<div class="col-span-3 text-center text-slate-400 py-4 text-sm">è¼‰å…¥æ°£è±¡è³‡æ–™ä¸­...</div>';
            
            await new Promise(r => setTimeout(r, 600));
            const baseTemps = { tokyo: 15, osaka: 18, kyoto: 14, fukuoka: 19, sapporo: 5, okinawa: 24 };
            const t = baseTemps[city] || 15;
            
            const days = ['ä»Šå¤©', 'æ˜å¤©', 'å¾Œå¤©'];
            let html = '';
            
            const todayTemp = t;
            const todayDesc = 'æ™´æ™‚å¤šé›²';
            const todayIcon = 'sun';
            const tip = t < 10 ? "å¤©æ°£å¯’å†·ï¼Œè«‹å‹™å¿…æ”œå¸¶åšå¤–å¥—èˆ‡åœå·¾ã€‚" : 
                       (t < 20 ? "ç¨æœ‰æ¶¼æ„ï¼Œå»ºè­°æ´‹è”¥å¼ç©¿æ­ã€‚" : "å¤©æ°£æº«æš–ï¼Œç©¿è‘—èˆ’é©é€æ°£è¡£ç‰©å³å¯ã€‚");

            let bottomRow = `<div class="col-span-3 grid grid-cols-2 gap-2">`;
            for(let i=1; i<=2; i++) {
                 const dayTemp = t + (i*1) + Math.floor(Math.random()*3);
                 bottomRow += `
                    <div class="bg-slate-800/50 border border-slate-700 p-2 rounded-lg flex flex-col items-center justify-center">
                        <span class="text-xs text-sky-300 font-bold mb-1">${days[i]}</span>
                        <i data-lucide="cloud" class="w-5 h-5 text-gray-400 mb-1"></i>
                        <span class="text-sm font-bold text-white">${dayTemp}Â°</span>
                    </div>
                 `;
            }
            bottomRow += `</div>`;
            
            html = `
                <div class="col-span-3 bg-slate-900/80 border border-slate-600 p-4 rounded-lg flex flex-row items-center justify-between mb-2">
                     <div class="flex items-center gap-4">
                        <div class="text-center">
                             <div class="text-sm text-sky-300 font-bold mb-1">ä»Šå¤©</div>
                             <i data-lucide="${todayIcon}" class="w-12 h-12 text-yellow-400"></i>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-4xl font-bold text-white">${todayTemp}Â°</span>
                            <span class="text-sm text-slate-400">${todayDesc}</span>
                        </div>
                     </div>
                     <div class="flex flex-col items-end text-right max-w-[50%] border-l border-slate-700 pl-4">
                         <span class="text-sky-400 font-bold text-xs mb-1">ç©¿æ­å»ºè­°</span>
                         <div class="text-xs text-slate-300 leading-relaxed">
                             ${tip}
                         </div>
                     </div>
                </div>
                ${bottomRow}
            `;
            
            container.innerHTML = html;
            updateIcons();
        }

        // PROXY LIST (Moved to Shopping Tab)
        function renderProxyList() {
            const container = $('proxy-list-container');
            if(!container) return;
            container.innerHTML = '';
            const list = window.state.customShopTargets || [];
            if(list.length === 0) { container.innerHTML = '<span class="text-slate-500 text-xs">ç„¡è‡ªå®šç¾©åå–®</span>'; return; }
            list.forEach(name => {
                const tag = document.createElement('span');
                tag.className = 'bg-pink-900/40 text-pink-300 px-2 py-1 rounded text-xs flex items-center border border-pink-900';
                tag.innerHTML = `${name} <button onclick="window.removeProxyTarget('${name}')" class="ml-1 text-pink-500 hover:text-white"><i data-lucide="x" class="w-3 h-3"></i></button>`;
                container.appendChild(tag);
            });
            updateIcons();
        }
        window.addProxyTarget = () => {
            const input = $('new-proxy-name');
            const name = input.value.trim();
            if(!name) return;
            let list = window.state.customShopTargets;
            if(!list.includes(name)) {
                list.push(name);
                window.state.customShopTargets = list;
                localStorage.setItem('custom_shop_targets', JSON.stringify(list));
                saveData('customShopTargets', list);
            }
            input.value = '';
            renderProxyList();
        }
        
        // FIXED REMOVE PROXY
        window.removeProxyTarget = (name) => {
            window.showConfirm(`ç¢ºå®šè¦ç§»é™¤ä»£è³¼å°è±¡ ${name} å—ï¼Ÿ`, () => {
                let list = window.state.customShopTargets.filter(n => n !== name);
                window.state.customShopTargets = list;
                localStorage.setItem('custom_shop_targets', JSON.stringify(list));
                saveData('customShopTargets', list);
                renderProxyList();
            });
        }

        // PARTICIPANTS
        function renderCurrentUserSelect() {
            const select = DOM.currentUserSelect;
            const current = localStorage.getItem('trip_current_user') || '';
            
            select.innerHTML = '<option value="">-- è«‹é¸æ“‡æˆ‘æ˜¯èª° --</option>';
            window.state.participants.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p;
                opt.textContent = p;
                if (p === current) opt.selected = true;
                select.appendChild(opt);
            });

            if (current && window.state.participants.includes(current)) {
                DOM.currentUserName.textContent = current;
                DOM.currentUserBadge.classList.remove('hidden');
            } else {
                DOM.currentUserBadge.classList.add('hidden');
            }
        }

        window.saveCurrentUser = function() {
            const val = DOM.currentUserSelect.value;
            if (val) {
                localStorage.setItem('trip_current_user', val);
                showToast(`è£ç½®ä½¿ç”¨è€…å·²è¨­å®šç‚º: ${val}`);
                renderCurrentUserSelect();
                renderDetailedParticipants(); 
                renderShoppingList(); 
            } else {
                localStorage.removeItem('trip_current_user');
                showToast('å·²æ¸…é™¤ä½¿ç”¨è€…è¨­å®š');
                renderCurrentUserSelect();
                renderDetailedParticipants();
                renderShoppingList();
            }
        }

        window.showImage = (src) => { openModal(`<div onclick="window.closeModal('modal-img')" class="modal-enter fixed inset-0 bg-black/90 flex items-center justify-center z-[60] p-4 cursor-pointer"><img src="${src}" class="max-w-full max-h-[90vh] rounded shadow-2xl"></div>`); }
        
        // --- EXPENSE FUNCTIONS (RESTORED) ---
        window.showAddExpenseModal = function(idx = -1) {
            const isEdit = idx !== -1;
            const item = isEdit ? window.state.expenses[idx] : { desc: '', amount: '', currency: 'JPY', payer: localStorage.getItem('trip_current_user'), method: 'Cash', isGroup: false };
            
            const parts = window.state.participants; 
            if (parts.length === 0) return showToast('è«‹å…ˆåœ¨ã€Œè³‡è¨Šã€é ç±¤æ–°å¢æ—…ä¼´!', 'error');
            
            const payerOpts = parts.map(p => `<option value="${p}" ${p === item.payer ? 'selected' : ''}>${p}</option>`).join('');
            
            const splitOpts = parts.map(p => {
                let amt = '';
                let checked = false;
                
                if (isEdit && item.isGroup && item.splitDetails) {
                    const detail = item.splitDetails.find(d => d.name === p);
                    if (detail) {
                        amt = detail.amount;
                        checked = true;
                    }
                } else if (!isEdit) {
                    // Default to current user checked if new
                    if (p === localStorage.getItem('trip_current_user')) checked = true;
                }

                return `
                <div class="flex items-center justify-between bg-slate-900 p-2 rounded border border-slate-700">
                    <label class="flex items-center text-sm text-secondary">
                        <input type="checkbox" name="split-p" value="${p}" class="mr-2 w-4 h-4 rounded text-green-500 focus:ring-0 bg-slate-700 border-slate-500" 
                            ${checked ? 'checked' : ''} onchange="window.toggleSplitInput(this, '${p}')"> ${p}
                    </label>
                    <input type="number" id="split-amt-${p}" value="${amt}" class="w-20 bg-slate-800 border border-slate-600 rounded p-1 text-right text-sm text-white" ${checked ? '' : 'disabled'} placeholder="0">
                </div>`;
            }).join('');

            const html = `
                <div id="modal-expense" class="modal-enter fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                    <div class="card-bg w-full max-w-md rounded-2xl p-5 shadow-2xl max-h-[90vh] overflow-y-auto">
                        <h3 class="text-lg font-bold text-white mb-4">${isEdit ? 'ç·¨è¼¯' : 'æ–°å¢'}è¨˜å¸³</h3>
                        <form id="add-expense-form" class="space-y-3">
                            <input type="text" name="desc" value="${item.desc}" placeholder="é …ç›® (å¦‚: æ™šé¤)" class="w-full bg-slate-800 border-slate-600 rounded-lg p-3 text-white" required>
                            <div class="flex gap-2">
                                <input type="number" id="expense-amount" name="amount" value="${item.amount}" placeholder="é‡‘é¡" inputmode="decimal" class="flex-1 bg-slate-800 border-slate-600 rounded-lg p-3 text-white" required>
                                <select name="currency" class="w-24 bg-slate-800 border-slate-600 rounded-lg p-3 text-white">
                                    <option value="JPY" ${item.currency === 'JPY' ? 'selected' : ''}>JPY</option>
                                    <option value="TWD" ${item.currency === 'TWD' ? 'selected' : ''}>TWD</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <select name="payer" id="expense-payer" class="bg-slate-800 border-slate-600 rounded-lg p-3 text-white">${payerOpts}</select>
                                <select name="method" id="expense-payment-method" class="bg-slate-800 border-slate-600 rounded-lg p-3 text-white">
                                    <option value="Cash" ${item.paymentMethod === 'Cash' ? 'selected' : ''}>ç¾é‡‘</option>
                                    <option value="Card" ${item.paymentMethod === 'Card' ? 'selected' : ''}>åˆ·å¡</option>
                                </select>
                            </div>
                            
                            <div class="pt-2">
                                <label class="flex items-center text-white text-sm">
                                    <input type="checkbox" id="is-group-expense" name="isGroup" class="mr-2 w-5 h-5 rounded text-green-500 focus:ring-0 bg-slate-700 border-slate-500" onchange="window.toggleGroup(this)" ${item.isGroup ? 'checked' : ''}>
                                    ç¾¤çµ„åˆ†å¸³ (éœ€çµç®—)
                                </label>
                            </div>

                            <div id="group-sec" class="${item.isGroup ? '' : 'hidden'} space-y-2 pt-2 border-t border-slate-700">
                                <button type="button" onclick="window.autoSplitAmount()" class="w-full bg-yellow-600/80 text-white py-2 rounded-lg text-sm flex justify-center items-center"><i data-lucide="zap" class="w-4 h-4 mr-1"></i> è‡ªå‹•å¹³å‡åˆ†æ”¤</button>
                                <div class="grid grid-cols-1 gap-2 max-h-40 overflow-y-auto">${splitOpts}</div>
                            </div>

                            <div class="flex gap-3 pt-4">
                                <button type="button" onclick="window.closeModal('modal-expense')" class="flex-1 py-3 text-slate-400 bg-slate-800 rounded-lg">å–æ¶ˆ</button>
                                <button type="submit" class="flex-1 py-3 bg-green-600 text-white rounded-lg font-bold">å„²å­˜</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            window.openModal(html);
            
            // Attach submit handler with index
            const form = document.getElementById('add-expense-form');
            form.onsubmit = (e) => handleAddExpense(e, idx);
        }

        window.toggleGroup = (cb) => {
            const groupSec = document.getElementById('group-sec');
            if(groupSec) groupSec.classList.toggle('hidden', !cb.checked);
        }

        window.toggleSplitInput = (cb, name) => {
            const inp = document.getElementById(`split-amt-${name}`);
            if (inp) {
                inp.disabled = !cb.checked;
                if(!cb.checked) inp.value = '';
            }
        }

        window.autoSplitAmount = () => {
            const total = parseFloat(document.getElementById('expense-amount').value);
            if (!total) return showToast('è«‹å…ˆè¼¸å…¥é‡‘é¡', 'error');
            const cbs = Array.from(document.querySelectorAll('input[name="split-p"]:checked'));
            if (cbs.length === 0) return showToast('è«‹å‹¾é¸åˆ†æ”¤äºº', 'error');
            
            const per = total / cbs.length;
            
            cbs.forEach((cb) => {
                const inp = document.getElementById(`split-amt-${cb.value}`);
                if(inp) inp.value = per.toFixed(2);
            });
        }

        async function handleAddExpense(e, idx) {
            e.preventDefault();
            const form = e.target;
            const isGroup = form.isGroup.checked;
            const totalAmount = parseFloat(form.amount.value);
            const paymentMethod = form.method.value;
            const payer = form.payer.value;
            
            if (!payer) return showToast('è«‹é¸æ“‡æ”¯ä»˜è€…', 'error');

            let splitDetails = [];

            if (isGroup) {
                const checkedBoxes = Array.from(document.querySelectorAll('input[name="split-p"]:checked'));
                if (checkedBoxes.length === 0) return showToast('è«‹å‹¾é¸åˆ†å¸³æˆå“¡', 'error');

                let totalSplitCheck = 0;
                for (const checkbox of checkedBoxes) {
                    const name = checkbox.value;
                    const amountInput = document.getElementById(`split-amt-${name}`);
                    const splitAmount = parseFloat(amountInput.value) || 0;

                    if (splitAmount <= 0) return showToast(`è«‹è¼¸å…¥ ${name} çš„é‡‘é¡`, 'error');

                    splitDetails.push({ name: name, amount: splitAmount });
                    totalSplitCheck += splitAmount;
                }
                
                if (Math.abs(totalSplitCheck - totalAmount) > 0.02) {
                    return showToast(`åˆ†å¸³ç¸½é¡ (${totalSplitCheck.toFixed(2)}) ä¸ç­‰æ–¼ç¸½æ”¯å‡º (${totalAmount.toFixed(2)})`, 'error');
                }
            }
            
            const newExpense = {
                description: form.desc.value.trim(),
                amount: totalAmount,
                currency: form.currency.value,
                payer: payer,
                paymentMethod: paymentMethod, 
                isGroup: isGroup,
                splitDetails: splitDetails, 
                timestamp: Date.now()
            };

            if (idx !== -1) {
                window.state.expenses[idx] = newExpense;
            } else {
                window.state.expenses.push(newExpense);
            }
            
            await saveData('expenses', window.state.expenses);
            window.closeModal('modal-expense');
        }

        // FIXED DELETE EXPENSE
        window.deleteExpense = async (idx) => {
            window.showConfirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç­†æ”¯å‡ºç´€éŒ„ï¼Ÿ', async () => {
                window.state.expenses.splice(idx, 1);
                await saveData('expenses', window.state.expenses);
            });
        }

        function renderExpensesAndCalc() { 
            const list = window.state.expenses; const elList = $('expense-list'); let totalTWD = 0;
            elList.innerHTML = '';
            if (list.length === 0) $('expense-empty').classList.remove('hidden'); else $('expense-empty').classList.add('hidden');
            let net = {}; window.state.participants.forEach(p => net[p]=0);
            list.forEach((item, idx) => {
                const rate = window.state.JPY_TO_TWD_RATE; 
                const amtTWD = item.currency === 'JPY' ? item.amount * rate : item.amount;
                totalTWD += amtTWD;
                if(item.isGroup && item.splitDetails) {
                    item.splitDetails.forEach(d => {
                        const share = item.currency === 'JPY' ? d.amount * rate : d.amount;
                        if(net[d.name]!==undefined) net[d.name] -= share;
                        if(net[item.payer]!==undefined) net[item.payer] += share;
                    });
                }
                const li = document.createElement('li'); li.className = `card-bg p-4 rounded-xl shadow-md border-l-4 ${item.isGroup ? 'border-red-400' : 'border-green-400'}`;
                li.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-primary">${item.description}</h3>
                            <p class="text-xs text-secondary mt-1">${item.payer} ä»˜äº† <span class="text-primary font-bold">${item.amount} ${item.currency}</span></p>
                        </div>
                        <div class="flex gap-2">
                             <button onclick="window.showAddExpenseModal(${idx})" class="text-blue-400 p-2"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                             <button onclick="window.deleteExpense(${idx})" class="text-red-400 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                `;
                elList.appendChild(li);
            });
            window.state.expenseSummary.netSettlement = net; 
            $('total-twd').textContent = Math.round(totalTWD);
            renderSettlementTable(net);
            renderDetailedParticipants(); 
        }

        function renderSettlementTable(net) { 
            let payers=[], receivers=[]; for(let p in net){ if(net[p]<-1) payers.push({name:p, amt:-net[p]}); else if(net[p]>1) receivers.push({name:p, amt:net[p]}); }
            payers.sort((a,b)=>b.amt-a.amt); receivers.sort((a,b)=>b.amt-a.amt);
            let txs=[]; let i=0,j=0; while(i<payers.length && j<receivers.length){ let min=Math.min(payers[i].amt, receivers[j].amt); if(min>0){ txs.push({from:payers[i].name, to:receivers[j].name, val:min}); payers[i].amt-=min; receivers[j].amt-=min; } if(payers[i].amt<1)i++; if(receivers[j].amt<1)j++; }
            const c=$('settlement-section'); const l=$('settlement-transactions'); l.innerHTML='';
            if(txs.length>0){ c.classList.remove('hidden'); $('total-settlement').textContent=`${txs.length} ç­†å¾…è½‰`; txs.forEach(t=>{ l.innerHTML+=`<div class="flex justify-between items-center bg-slate-900 p-2 rounded border border-red-900/30"><span>${t.from}</span><i data-lucide="arrow-right" class="w-4 h-4 text-red-400"></i><span>${t.to}</span><span class="text-red-300 font-bold">NT$ ${Math.round(t.val)}</span></div>`; }); } else { c.classList.add('hidden'); $('total-settlement').textContent='å·²çµæ¸…'; }
        }
        
        window.addParticipant = () => {
            const n = $('new-participant-name').value.trim();
            if(!n) return;
            if(window.state.participants.includes(n)) return showToast('é‡è¤‡', 'error');
            window.state.participants.push(n);
            window.state.travelDetails.participantsDetails.push({name:n});
            saveData('participants', window.state.participants);
            saveData('travelDetails', window.state.travelDetails);
            $('new-participant-name').value='';
        }
        
        // FIXED DEL PARTICIPANT
        window.delPart = (n) => {
            window.showConfirm(`ç¢ºå®šè¦ç§»é™¤æ—…ä¼´ ${n} å—ï¼Ÿ`, () => {
                window.state.participants = window.state.participants.filter(p=>p!==n);
                saveData('participants', window.state.participants);
            });
        }
        
        window.showEditFlightModal = () => { const f = window.state.travelDetails.flight || {}; window.openModal(`<div id="modal-flight" class="modal-enter fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4"><div class="card-bg w-full max-w-sm rounded-2xl p-5"><h3 class="font-bold text-white mb-4">èˆªç­è³‡è¨Š</h3><form id="form-flight" class="space-y-3"><input type="text" name="out" placeholder="å»ç¨‹" value="${f.outbound||''}" class="w-full bg-slate-800 border-slate-600 rounded p-2 text-white"><input type="text" name="ret" placeholder="å›ç¨‹" value="${f.return||''}" class="w-full bg-slate-800 border-slate-600 rounded p-2 text-white"><textarea name="note" placeholder="å‚™è¨»" class="w-full bg-slate-800 border-slate-600 rounded p-2 text-white">${f.notes||''}</textarea><div class="flex gap-3 mt-4"><button type="button" onclick="window.closeModal('modal-flight')" class="flex-1 py-2 bg-slate-700 text-white rounded">å–æ¶ˆ</button><button type="submit" class="flex-1 py-2 bg-blue-600 text-white rounded">å„²å­˜</button></div></form></div></div>`); document.getElementById('form-flight').onsubmit=(e)=>{e.preventDefault(); const f=e.target; window.state.travelDetails.flight={outbound:f.out.value, return:f.ret.value, notes:f.note.value}; saveData('travelDetails', window.state.travelDetails); window.closeModal('modal-flight');} }
        window.convertCurrency = (t) => { const r = window.state.JPY_TO_TWD_RATE; if(t==='TWD'){ const v=parseFloat($('twd-input').value); if(v) $('jpy-input').value=(v/r).toFixed(0); } else { const v=parseFloat($('jpy-input').value); if(v) $('twd-input').value=(v*r).toFixed(0); } }
        window.openModal = (html) => { const c=$('modal-container'); c.innerHTML=html; setTimeout(()=>c.firstElementChild.classList.add('modal-enter-active'),10); if(html.includes('id="add-expense-form"')) $('add-expense-form').addEventListener('submit', handleAddExpense); }
        window.closeModal = (id) => { const el=$(id); if(el) { el.classList.remove('modal-enter-active'); setTimeout(()=>el.remove(),200); } }
        window.showToast = (msg, type='success') => { const t=document.createElement('div'); t.className='toast show'; if(type==='error') t.style.background='rgba(220,38,38,0.9)'; t.textContent=msg; DOM.toastContainer.appendChild(t); setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),300); }, 2500); }
        $('tabs').onclick = (e) => { const btn=e.target.closest('.tab-btn'); if(!btn)return; document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); document.querySelectorAll('.tab-page').forEach(p=>p.classList.add('hidden')); btn.classList.add('active'); $(btn.dataset.tab).classList.remove('hidden'); updateIcons(); }
        
        window.showShoppingSettlement = () => { /* ... */ const list=window.state.shoppingList; let total=0; list.forEach(i=>{if(i.isBought)total+=i.price*(i.buyers?i.buyers.reduce((s,b)=>s+b.qty,0):1);}); window.openModal(`<div id="m" class="modal-enter fixed inset-0 bg-black/80 flex items-center justify-center p-4"><div class="card-bg p-5 rounded-xl w-full max-w-sm"><h3 class="text-white font-bold mb-4">ä»£è³¼ç¸½çµç®—</h3><p class="text-white">å·²è³¼ç¸½é¡: Â¥${total}</p><p class="text-slate-400 text-sm">â‰ˆ NT$${Math.round(total*0.2185)}</p><button onclick="window.closeModal('m')" class="w-full mt-4 bg-slate-700 text-white py-2 rounded">é—œé–‰</button></div></div>`); }
        
        // --- RESTORE renderParticipants ---
        function renderParticipants() { 
            const list = $('participants-list'); 
            if(!list) return;
            list.innerHTML = ''; 
            
            if(window.state.participants.length === 0) {
            }

            window.state.participants.forEach(p => { 
                const s = document.createElement('span'); 
                s.className = 'bg-blue-600 text-white text-xs px-3 py-1 rounded-full flex items-center'; 
                s.innerHTML = `${p} <button onclick="window.delPart('${p}')" class="ml-2 text-blue-200"><i data-lucide="x" class="w-3 h-3"></i></button>`; 
                list.appendChild(s); 
            }); 
            
            updateIcons(); 
        }

        function renderDetailedParticipants() { 
            const c=$('detailed-participants-list'); if(!c)return; c.innerHTML=''; const cur=localStorage.getItem('trip_current_user'); let sp=[...window.state.participants]; if(cur&&sp.includes(cur)) sp=[cur, ...sp.filter(p=>p!==cur)]; 
            const emptyMsg = document.getElementById('detailed-participants-empty');
            if(sp.length===0){ if(emptyMsg) emptyMsg.classList.remove('hidden'); return; } 
            if(emptyMsg) emptyMsg.classList.add('hidden'); 
            sp.forEach(name=>{ const d=window.state.travelDetails.participantsDetails.find(x=>x.name===name)||{name}; const net=window.state.expenseSummary.netSettlement[name]||0; const isMe=name===cur; const div=document.createElement('div'); div.className=`bg-slate-700 p-4 rounded-xl border-l-4 ${net>=0?'border-green-400':'border-red-400'} ${isMe?'ring-2 ring-yellow-500':''}`; div.innerHTML=`<div class="flex justify-between items-center mb-3"><div class="flex items-center"><h4 class="font-bold text-white text-lg">${d.nickname||name}</h4>${isMe?'<span class="ml-2 text-[10px] bg-yellow-600 text-white px-1.5 rounded">æˆ‘</span>':''}</div><button onclick="window.prepareEditPartDetail('${name}')" class="text-xs bg-slate-600 text-white px-2 py-1 rounded">ç·¨è¼¯</button></div><div class="space-y-2 text-sm"><p class="text-slate-300">è­·ç…§: ${d.passportNumber||'-'} <button onclick="copyText('${d.passportNumber||''}')" class="text-blue-400"><i data-lucide="copy" class="w-3 h-3 inline"></i></button></p><p class="text-slate-300">Email: ${d.email||'-'}</p></div><div class="mt-2 pt-2 border-t border-slate-600 flex justify-between"><span class="text-xs text-secondary">æ·¨é¤˜é¡</span><span class="font-bold ${net>=0?'text-green-400':'text-red-400'}">${net>=0?'æ”¶':'ä»˜'} ${Math.abs(Math.round(net))}</span></div>`; c.appendChild(div); }); 
        }
        
        window.prepareEditPartDetail = (name) => {
            const detail = window.state.travelDetails.participantsDetails.find(d => d.name === name) || { name };
            window.editPartDetail(detail);
        };

        window.editPartDetail = (detail) => {
            const html = `
                <div id="modal-part" class="modal-enter fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                    <div class="card-bg w-full max-w-sm rounded-2xl p-5 overflow-y-auto max-h-[90vh]">
                        <h3 class="font-bold text-white mb-4">ç·¨è¼¯ ${detail.name} è³‡æ–™</h3>
                        <form id="form-part" class="space-y-3">
                            <div>
                                <label class="text-xs text-secondary">ç¶½è™Ÿ/é¡¯ç¤ºåç¨±</label>
                                <input type="text" name="nickname" value="${detail.nickname||''}" class="w-full bg-slate-800 border-slate-600 rounded p-2 text-white">
                            </div>
                            <div class="flex gap-2">
                                <div class="flex-1">
                                    <label class="text-xs text-secondary">è­·ç…§å§“ (Surname)</label>
                                    <input type="text" name="pSurname" placeholder="LEE" value="${detail.passportSurname||''}" class="w-full bg-slate-800 border-slate-600 rounded p-2 text-white">
                                </div>
                                <div class="flex-1">
                                    <label class="text-xs text-secondary">è­·ç…§å (Given Name)</label>
                                    <input type="text" name="pGiven" placeholder="DA-MING" value="${detail.passportGivenName||''}" class="w-full bg-slate-800 border-slate-600 rounded p-2 text-white">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-secondary">è­·ç…§ä¸­æ–‡å§“å</label>
                                <input type="text" name="pChinese" value="${detail.passportChinese||''}" class="w-full bg-slate-800 border-slate-600 rounded p-2 text-white">
                            </div>
                            <div>
                                <label class="text-xs text-secondary">è­·ç…§è™Ÿç¢¼</label>
                                <input type="text" name="pNumber" value="${detail.passportNumber||''}" class="w-full bg-slate-800 border-slate-600 rounded p-2 text-white">
                            </div>
                            <div>
                                <label class="text-xs text-secondary">Email</label>
                                <input type="email" name="email" value="${detail.email||''}" class="w-full bg-slate-800 border-slate-600 rounded p-2 text-white">
                            </div>
                            <div class="flex gap-3 mt-4">
                                <button type="button" onclick="window.closeModal('modal-part')" class="flex-1 py-2 bg-slate-700 text-white rounded">å–æ¶ˆ</button>
                                <button type="submit" class="flex-1 py-2 bg-blue-600 text-white rounded">å„²å­˜</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            window.openModal(html);
            document.getElementById('form-part').onsubmit = (e) => {
                e.preventDefault();
                const f = e.target;
                const updated = {
                    name: detail.name,
                    nickname: f.nickname.value,
                    passportSurname: f.pSurname.value,
                    passportGivenName: f.pGiven.value,
                    passportChinese: f.pChinese.value,
                    passportNumber: f.pNumber.value,
                    email: f.email.value
                };
                
                const newDetails = window.state.travelDetails.participantsDetails.map(d => d.name === detail.name ? { ...d, ...updated } : d);
                if(!newDetails.find(d => d.name === detail.name)) newDetails.push(updated);
                
                window.state.travelDetails.participantsDetails = newDetails;
                saveData('travelDetails', window.state.travelDetails);
                window.closeModal('modal-part');
            };
        }

        // --- SHOPPING FUNCTIONS (RESTORED) ---
        window.showAddShoppingItemModal = function(editId = null) {
            const parts = window.state.participants;
            const currentUser = localStorage.getItem('trip_current_user');

            if (!currentUser) return showToast('è«‹å…ˆåœ¨ã€Œè³‡è¨Šã€é ç±¤è¨­å®šæœ¬æ©Ÿä½¿ç”¨è€…ï¼Œæ‰èƒ½æ–°å¢è³¼ç‰©æ¸…å–®ã€‚', 'error');

            const customTargets = window.state.customShopTargets || [];
            
            let item = { price: '', name: '', note: '', url: '', image: '', buyers: [] };
            if (editId) {
                const found = window.state.shoppingList.find(i => i.id == editId);
                if (found) {
                    item = found;
                    if (!item.buyers && item.forWhom) {
                        item.buyers = [{name: item.forWhom, qty: item.qty || 1}];
                    }
                }
            } else {
                item.buyers = [{name: currentUser, qty: 1}];
            }

            let allOptions = [...parts, ...customTargets];
            if(item.buyers) {
                item.buyers.forEach(b => {
                    if(!allOptions.includes(b.name)) allOptions.push(b.name);
                });
            }
            allOptions = [...new Set(allOptions)];

            const checkboxesHtml = allOptions.map(p => {
                const buyer = item.buyers.find(b => b.name === p);
                const isChecked = !!buyer;
                const qtyVal = buyer ? buyer.qty : 1;
                return `
                <div class="flex items-center justify-between bg-slate-700/50 p-2 rounded border border-slate-600 mb-2">
                    <label class="flex items-center text-sm text-white flex-1 cursor-pointer select-none">
                        <input type="checkbox" name="shop-target" value="${p}" 
                            class="mr-2 w-5 h-5 rounded text-pink-500 focus:ring-0 bg-slate-800 border-slate-500" 
                            ${isChecked ? 'checked' : ''} onchange="window.toggleShopQty(this, '${p}')">
                        ${p}
                    </label>
                    <input type="number" id="shop-qty-${p}" value="${qtyVal}" min="1" 
                        class="w-20 bg-slate-800 border border-slate-600 rounded p-1 text-center text-white text-sm ${isChecked ? '' : 'opacity-50 pointer-events-none'}" 
                        ${isChecked ? '' : 'disabled'}>
                </div>`;
            }).join('');

            const html = `
                <div id="modal-shop" class="modal-enter fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                    <div class="card-bg w-full max-w-md rounded-2xl p-5 shadow-2xl overflow-y-auto max-h-[90vh]">
                        <h3 class="text-lg font-bold text-white mb-4">${editId ? 'ç·¨è¼¯' : 'æ–°å¢'}è³¼ç‰©/ä»£è³¼é …ç›®</h3>
                        <form id="form-shop" class="space-y-3">
                            <input type="text" name="name" placeholder="å•†å“åç¨±" value="${item.name}" class="w-full bg-slate-800 border-slate-600 rounded-lg p-3 text-white" required>
                            
                            <div class="bg-slate-800 border border-slate-600 rounded-lg p-3">
                                <label class="block text-xs text-secondary mb-1">å•†å“åœ–ç‰‡ (å¯é¸)</label>
                                <div class="flex items-center justify-between">
                                     <input type="file" id="shop-img-input" accept="image/*" class="w-full text-xs text-slate-400 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:bg-slate-700 file:text-white hover:file:bg-slate-600">
                                     <button type="button" onclick="window.triggerGeminiProduct()" class="bg-purple-600 hover:bg-purple-700 text-white text-xs px-2 py-1 rounded ml-2 flex items-center whitespace-nowrap">
                                        <i data-lucide="sparkles" class="w-3 h-3 mr-1"></i>AI è¾¨è­˜
                                     </button>
                                </div>
                                <input type="hidden" name="image" id="shop-img-base64" value="${item.image || ''}">
                                <div id="shop-img-preview" class="mt-2 ${item.image ? '' : 'hidden'}">
                                    <img src="${item.image || ''}" class="h-24 rounded border border-slate-600 object-cover">
                                    <button type="button" onclick="window.clearShopImg()" class="text-xs text-red-400 mt-1">ç§»é™¤åœ–ç‰‡</button>
                                </div>
                            </div>

                            <input type="url" name="url" placeholder="å•†å“ç¶²å€ (https://...)" value="${item.url || ''}" class="w-full bg-slate-800 border-slate-600 rounded-lg p-3 text-white">

                            <input type="number" name="price" placeholder="å–®åƒ¹ (JPY)" value="${item.price}" class="w-full bg-slate-800 border-slate-600 rounded-lg p-3 text-white">
                            
                            <div class="border-t border-slate-700 pt-3 mt-2">
                                <label class="block text-xs text-secondary mb-2">å¹«èª°è²· (å‹¾é¸ä¸¦è¼¸å…¥æ•¸é‡)</label>
                                <div id="shop-target-list" class="max-h-40 overflow-y-auto pr-1">
                                    ${checkboxesHtml}
                                </div>
                            </div>

                            <textarea name="note" placeholder="å‚™è¨» (å‹è™Ÿã€é¡è‰²...)" class="w-full bg-slate-800 border-slate-600 rounded-lg p-3 text-white">${item.note}</textarea>
                            
                            <div class="flex gap-3 mt-4">
                                <button type="button" onclick="window.closeModal('modal-shop')" class="flex-1 py-3 text-slate-400 bg-slate-800 rounded-lg">å–æ¶ˆ</button>
                                <button type="submit" class="flex-1 py-3 bg-pink-600 text-white rounded-lg font-bold">å„²å­˜</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            window.openModal(html);

            const imgInput = document.getElementById('shop-img-input');
            if(imgInput) {
                imgInput.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        if (file.size > 1024 * 1024) return showToast('åœ–ç‰‡å¤ªå¤§ï¼Œè«‹å°æ–¼ 1MB', 'error');
                        const reader = new FileReader();
                        reader.onload = (evt) => {
                            const base64 = evt.target.result;
                            document.getElementById('shop-img-base64').value = base64;
                            const preview = document.getElementById('shop-img-preview');
                            preview.classList.remove('hidden');
                            preview.querySelector('img').src = base64;
                        };
                        reader.readAsDataURL(file);
                    }
                };
            }
            
            const form = document.getElementById('form-shop');
            form.onsubmit = async (e) => {
                e.preventDefault();
                const f = e.target;

                const checkboxes = document.querySelectorAll('input[name="shop-target"]:checked');
                if (checkboxes.length === 0) return showToast('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹è³¼è²·å°è±¡', 'error');

                const buyers = [];
                checkboxes.forEach(cb => {
                    const name = cb.value;
                    const qtyInp = document.getElementById(`shop-qty-${name}`);
                    buyers.push({
                        name: name,
                        qty: parseInt(qtyInp.value) || 1
                    });
                });

                const newItem = {
                    id: editId || Date.now(),
                    name: f.name.value.trim(),
                    price: parseFloat(f.price.value) || 0,
                    note: f.note.value,
                    url: f.url.value,
                    image: f.image.value,
                    isBought: item.isBought || false,
                    creator: item.creator || currentUser,
                    buyers: buyers
                };

                if (editId) {
                    const idx = window.state.shoppingList.findIndex(i => i.id == editId);
                    if (idx > -1) window.state.shoppingList[idx] = newItem;
                } else {
                    window.state.shoppingList.push(newItem);
                }
                
                await saveData('shoppingList', window.state.shoppingList);
                window.closeModal('modal-shop');
            };
        }

        window.clearShopImg = () => {
            document.getElementById('shop-img-input').value = '';
            document.getElementById('shop-img-base64').value = '';
            document.getElementById('shop-img-preview').classList.add('hidden');
        }

        window.toggleShopQty = (cb, name) => {
            const input = document.getElementById(`shop-qty-${name}`);
            if (input) {
                if (cb.checked) {
                    input.disabled = false;
                    input.classList.remove('opacity-50', 'pointer-events-none');
                } else {
                    input.disabled = true;
                    input.classList.add('opacity-50', 'pointer-events-none');
                }
            }
        };

        window.toggleShopItem = async (id) => {
            const item = window.state.shoppingList.find(i => i.id == id);
            if(item) {
                item.isBought = !item.isBought;
                await saveData('shoppingList', window.state.shoppingList);
            }
        }

        // FIXED DELETE SHOP ITEM
        window.deleteShopItem = async (id) => {
            window.showConfirm('ç¢ºå®šè¦åˆªé™¤æ­¤è³¼ç‰©é …ç›®ï¼Ÿ', async () => {
                window.state.shoppingList = window.state.shoppingList.filter(i => i.id != id);
                await saveData('shoppingList', window.state.shoppingList);
                // Also close any modal if open (e.g. edit modal) to prevent confusion
                window.closeModal('modal-shop');
            });
        }

        function renderShoppingList() {
            const list = window.state.shoppingList;
            const container = $('shopping-list-container');
            const currentUser = localStorage.getItem('trip_current_user');
            
            if (!container) return; 

            container.innerHTML = '';
            
            const visibleList = list.filter(item => {
                const buyers = item.buyers || (item.forWhom ? [{name: item.forWhom}] : []);
                const hasPublicBuyer = buyers.some(b => window.state.participants.includes(b.name));
                if (hasPublicBuyer) return true;
                return item.creator === currentUser;
            });

            const emptyMsg = $('shopping-empty');
            if(visibleList.length === 0) {
                if(emptyMsg) emptyMsg.classList.remove('hidden');
            } else {
                if(emptyMsg) emptyMsg.classList.add('hidden');
            }

            let todoTotal = 0;
            let doneTotal = 0;

            visibleList.forEach(item => {
                const buyers = item.buyers || (item.forWhom ? [{name: item.forWhom, qty: item.qty || 1}] : []);
                const totalQty = buyers.reduce((sum, b) => sum + b.qty, 0);
                const total = item.price * totalQty;

                if (item.isBought) doneTotal += total;
                else todoTotal += total;

                const buyerBadges = buyers.map(b => {
                    const isPrivate = !window.state.participants.includes(b.name);
                    const pClass = isPrivate ? 'bg-slate-600 text-slate-300' : 'bg-pink-900/50 text-pink-300';
                    return `<span class="text-[10px] ${pClass} px-1.5 py-0.5 rounded border border-slate-600/50 mr-1">${b.name} x${b.qty}</span>`;
                }).join('');

                const div = document.createElement('div');
                div.className = `shop-item ${item.isBought ? 'bought' : ''} card-bg p-3 rounded-xl border border-slate-700 shadow flex flex-col gap-3`;
                
                div.innerHTML = `
                    <div class="flex items-start gap-3">
                        <button onclick="window.toggleShopItem(${item.id})" class="mt-1 w-6 h-6 rounded border ${item.isBought ? 'bg-green-500 border-green-500 text-white' : 'border-slate-500'} flex-shrink-0 flex items-center justify-center">
                            ${item.isBought ? '<i data-lucide="check" class="w-4 h-4"></i>' : ''}
                        </button>
                        
                        ${item.image ? `<img src="${item.image}" class="w-16 h-16 object-cover rounded bg-slate-800 border border-slate-600 cursor-pointer" onclick="window.showImage('${item.image}')">` : ''}

                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-white text-lg truncate">${item.name}</h4>
                            <div class="flex flex-wrap items-center mt-1 mb-1">
                                ${buyerBadges}
                            </div>
                            <p class="text-xs text-secondary flex items-center flex-wrap">
                                <span class="mr-2">ç¸½è¨ˆ: ${totalQty} å€‹ x Â¥${item.price}</span>
                                ${item.url ? `<a href="${item.url}" target="_blank" class="text-blue-400 hover:text-blue-300 flex items-center ml-2"><i data-lucide="link" class="w-3 h-3 mr-1"></i>ç¶²å€</a>` : ''}
                            </p>
                            ${item.note ? `<p class="text-xs text-slate-400 mt-1 line-clamp-2">${item.note}</p>` : ''}
                        </div>
                    </div>
                    
                    <div class="flex justify-end gap-2 border-t border-slate-700/50 pt-2">
                        <button onclick="window.showAddShoppingItemModal(${item.id})" class="text-blue-400 hover:text-blue-300 text-xs flex items-center px-2 py-1 rounded hover:bg-slate-800">
                            <i data-lucide="edit-3" class="w-3 h-3 mr-1"></i> ç·¨è¼¯
                        </button>
                        <button onclick="window.deleteShopItem('${item.id}')" class="text-red-400 hover:text-red-300 text-xs flex items-center px-2 py-1 rounded hover:bg-slate-800"><i data-lucide="trash-2" class="w-3 h-3 mr-1"></i> åˆªé™¤</button>
                    </div>
                `;
                container.appendChild(div);
            });
            
            $('shop-todo-total').textContent = `Â¥${todoTotal.toLocaleString()}`;
            $('shop-done-total').textContent = `Â¥${doneTotal.toLocaleString()}`;
            updateIcons();
        }
        
        function renderFlight() { 
            const f = window.state.travelDetails.flight || {}; 
            const display = $('flight-info-display');
            if(display) {
                display.innerHTML = `<div class="grid grid-cols-1 gap-2 text-sm"><p><span class="text-secondary">å»ç¨‹:</span> ${f.outbound||'-'}</p><p><span class="text-secondary">å›ç¨‹:</span> ${f.return||'-'}</p><p><span class="text-secondary">å‚™è¨»:</span> ${f.notes||'-'}</p></div>`; 
            }
        }

        function renderHotelInfo() {
            const h = window.state.travelDetails.hotel || {};
            const display = document.getElementById('hotel-info-display');
            if(!display) return; 
            
            const html = `
                <div class="grid grid-cols-1 gap-2 text-sm">
                    <p class="flex items-start"><span class="text-secondary w-16 shrink-0">åç¨±:</span> <span class="text-white">${h.name || '-'}</span> <button onclick="copyText('${h.name}')" class="ml-2 text-xs text-blue-400"><i data-lucide="copy" class="w-3 h-3"></i></button></p>
                    <p class="flex items-start"><span class="text-secondary w-16 shrink-0">åœ°å€:</span> <span class="text-white">${h.address || '-'}</span> <button onclick="copyText('${h.address}')" class="ml-2 text-xs text-blue-400"><i data-lucide="copy" class="w-3 h-3"></i></button></p>
                    <p class="flex items-start"><span class="text-secondary w-16 shrink-0">é›»è©±:</span> <span class="text-white">${h.phone || '-'}</span> <button onclick="copyText('${h.phone}')" class="ml-2 text-xs text-blue-400"><i data-lucide="copy" class="w-3 h-3"></i></button></p>
                    <p class="flex items-start"><span class="text-secondary w-16 shrink-0">å‚™è¨»:</span> <span class="text-slate-300">${h.note || '-'}</span></p>
                </div>
            `;
            display.innerHTML = html;
        }

        function renderPackingList() {
            const tab = window.state.currentPackTab;
            const list = window.state.packingList[tab] || [];
            const container = $('packing-list-container');
            if(!container) return;
            container.innerHTML = '';

            list.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = "flex items-center justify-between bg-slate-800 p-3 rounded-lg border border-slate-700 packing-item";
                div.innerHTML = `
                    <label class="flex items-center flex-1 cursor-pointer select-none">
                        <input type="checkbox" onchange="window.togglePackItem('${tab}', ${index})" class="w-5 h-5 rounded text-sky-500 bg-slate-700 border-slate-500 mr-3" ${item.checked ? 'checked' : ''}>
                        <span class="text-white text-sm transition-all">${item.text}</span>
                    </label>
                    <div class="flex items-center gap-1">
                        <button onclick="window.editPackItem('${tab}', ${index})" class="text-slate-500 hover:text-blue-400 p-1"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                        <button onclick="window.deletePackItem('${tab}', ${index})" class="text-slate-500 hover:text-red-400 p-1"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>
                `;
                container.appendChild(div);
            });
            updateIcons();
        }
        
        window.togglePackItem = (tab, index) => {
            const list = window.state.packingList;
            list[tab][index].checked = !list[tab][index].checked;
            saveData('packingList', list);
            renderPackingList();
        }

        window.addPackingItem = () => {
            const input = $('new-pack-item');
            const val = input.value.trim();
            if(!val) return;
            const tab = window.state.currentPackTab;
            window.state.packingList[tab].push({ id: Date.now(), text: val, checked: false });
            saveData('packingList', window.state.packingList);
            input.value = '';
        }
        
        window.switchPackTab = (tab) => {
            window.state.currentPackTab = tab;
            const btnOut = $('btn-pack-out');
            const btnIn = $('btn-pack-in');
            if(tab === 'outbound') {
                btnOut.className = "flex-1 py-2 text-center text-sm font-medium text-sky-400 border-b-2 border-sky-400";
                btnIn.className = "flex-1 py-2 text-center text-sm font-medium text-slate-500 border-b-2 border-transparent";
            } else {
                btnIn.className = "flex-1 py-2 text-center text-sm font-medium text-sky-400 border-b-2 border-sky-400";
                btnOut.className = "flex-1 py-2 text-center text-sm font-medium text-slate-500 border-b-2 border-transparent";
            }
            renderPackingList();
        }

        // Start App
        initApp();
        updateIcons();
    </script>
</body>
</html>
